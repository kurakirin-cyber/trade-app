<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è£…é£¾ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-lg px-4">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-lg mb-2 flex justify-between items-center text-white {% if category == 'error' %}bg-red-500{% else %}bg-blue-600{% endif %}">
                        <span>{{ message }}</span>
                        <button onclick="this.parentElement.remove()" class="font-bold">Ã—</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <header class="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-10 flex-none">
        <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <span>ğŸ“ˆ</span> ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ç®¡ç† v4.0
        </h1>
        <button onclick="createNewLog()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow transition flex items-center gap-2">
            <span>ï¼‹ å®Œå…¨æ–°è¦ä½œæˆ</span>
        </button>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <div class="w-64 bg-white border-r flex-none flex flex-col">
            <div class="p-3 bg-gray-50 border-b font-bold text-gray-500 text-xs">ğŸ“‚ éŠ˜æŸ„é¸æŠ</div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                {% if not registered_envs %}
                    <p class="text-xs text-center text-gray-400 py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</p>
                {% endif %}
                {% for code, data in registered_envs.items() %}
                    <button onclick="selectStock('{{ code }}')" class="w-full text-left p-3 rounded hover:bg-blue-50 transition border border-transparent hover:border-blue-100 group">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-blue-800 text-lg">{{ code }}</span>
                        </div>
                        <div class="text-xs text-gray-500 truncate">{{ data.name }}</div>
                    </button>
                {% endfor %}
            </div>
        </div>

        <div id="history_col" class="w-64 bg-gray-50 border-r flex-none flex flex-col hidden md:flex">
            <div class="p-3 bg-gray-100 border-b font-bold text-gray-500 text-xs flex justify-between items-center">
                <span>ğŸ•’ å±¥æ­´ä¸€è¦§</span>
                <span id="selected_code_display" class="text-blue-600"></span>
            </div>
            <div class="p-2 border-b">
                <button onclick="createNewLogForStock()" id="add_new_btn" class="w-full bg-white border-2 border-dashed border-gray-300 text-gray-500 py-2 rounded hover:border-blue-400 hover:text-blue-500 transition text-sm font-bold disabled:opacity-50">
                    ï¼‹ ã“ã®éŠ˜æŸ„ã§æ–°è¦è¨˜éŒ²
                </button>
            </div>
            <div id="history_list" class="flex-1 overflow-y-auto p-2 space-y-2">
                <p class="text-xs text-gray-400 text-center mt-4">éŠ˜æŸ„ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            </div>
        </div>

        <div class="flex-1 bg-white flex flex-col overflow-hidden relative">
            <form action="{{ url_for('save_data') }}" method="POST" enctype="multipart/form-data" class="flex-1 flex flex-col overflow-hidden">
                <input type="hidden" name="log_id" id="log_id">
                
                <div class="border-b p-4 flex justify-between items-center bg-white flex-none">
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold text-gray-400">ã‚³ãƒ¼ãƒ‰</label>
                            <input type="text" name="code" id="code" class="border-b-2 border-gray-300 focus:border-blue-500 outline-none font-bold text-xl w-24 bg-transparent" placeholder="9984" required>
                        </div>
                        <div class="flex flex-col flex-1">
                            <label class="text-[10px] font-bold text-gray-400">éŠ˜æŸ„å</label>
                            <input type="text" name="name" id="name" class="border-b border-gray-200 focus:border-blue-500 outline-none w-full bg-transparent" placeholder="éŠ˜æŸ„å">
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button type="button" id="copy_btn" onclick="copyDataToClipboard()" class="hidden bg-gray-700 hover:bg-gray-800 text-white py-2 px-4 rounded shadow text-sm flex items-center gap-2">
                            <span>ğŸ“‹ ã‚³ãƒ”ãƒ¼</span>
                        </button>
                        
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow flex items-center gap-2">
                            <span>ğŸ’¾ ä¿å­˜</span>
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                            <h3 class="text-xs font-bold text-yellow-800 mb-2">ğŸ’° ä¿æœ‰çŠ¶æ³</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" name="holding_qty" id="holding_qty" class="border p-2 rounded text-right" placeholder="æ ªæ•°">
                                <input type="number" name="avg_cost" id="avg_cost" class="border p-2 rounded text-right" placeholder="å˜ä¾¡">
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                            <h3 class="text-xs font-bold text-green-800 mb-2">ğŸ¯ æˆ¦ç•¥ (NotebookLMã®çµæœ)</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" name="target_buy" id="target_buy" class="border p-2 rounded text-center" placeholder="è²·ã„ç‹™ã„">
                                <input type="text" name="target_sell" id="target_sell" class="border p-2 rounded text-center" placeholder="å£²ã‚Šç‹™ã„">
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ğŸ“ ç’°å¢ƒèªè­˜ãƒ»ãƒ¡ãƒ¢</label>
                            <textarea name="memo" id="memo" class="w-full border p-3 rounded-lg text-sm h-40 focus:ring-2 ring-blue-100 outline-none" placeholder="æ°—ã¥ãã‚„è€ƒå¯Ÿ..."></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ğŸ¤– AIåˆ†æãƒ­ã‚° (ã‚³ãƒ”ãƒšç”¨)</label>
                            <textarea name="analysis_memo" id="analysis_memo" class="w-full border p-3 rounded-lg text-sm h-40 bg-green-50 focus:ring-2 ring-green-100 outline-none" placeholder="NotebookLMã®å›ç­”ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘..."></textarea>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="block text-xs font-bold text-gray-500">ğŸ“¸ ãƒãƒ£ãƒ¼ãƒˆç”»åƒ (ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´)</label>
                            <div class="flex gap-2">
                                <label class="flex-1 border-2 border-dashed rounded p-2 text-center cursor-pointer hover:bg-gray-50 text-xs">
                                    æ—¥è¶³<input type="file" name="img_daily" class="hidden" onchange="preview(this, 's_daily')">
                                    <div id="s_daily" class="text-gray-300 mt-1">æœª</div>
                                </label>
                                <label class="flex-1 border-2 border-dashed rounded p-2 text-center cursor-pointer hover:bg-gray-50 text-xs">
                                    5åˆ†è¶³<input type="file" name="img_5min" class="hidden" onchange="preview(this, 's_5min')">
                                    <div id="s_5min" class="text-gray-300 mt-1">æœª</div>
                                </label>
                                <label class="flex-1 border-2 border-dashed rounded p-2 text-center cursor-pointer hover:bg-gray-50 text-xs">
                                    æ¿<input type="file" name="img_board" class="hidden" onchange="preview(this, 's_board')">
                                    <div id="s_board" class="text-gray-300 mt-1">æœª</div>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ğŸ”— ãƒ‹ãƒ¥ãƒ¼ã‚¹URL</label>
                            <textarea name="urls" id="urls" class="w-full border p-2 rounded text-xs h-16" placeholder="https://..."></textarea>
                        </div>
                    </div>
                </div>
            </form>

            <div class="absolute bottom-4 right-6">
                <button onclick="deleteLog()" id="delete_btn" class="hidden text-red-400 text-xs hover:text-red-600 underline">
                    ã“ã®å±¥æ­´ã‚’å‰Šé™¤
                </button>
            </div>
        </div>
    </div>

    <form id="deleteForm" action="{{ url_for('delete_log') }}" method="POST" class="hidden">
        <input type="hidden" name="delete_log_id" id="delete_log_id">
    </form>

    <script>
        let currentCode = "";

        // éŠ˜æŸ„é¸æŠæ™‚ã®å‡¦ç†
        async function selectStock(code) {
            currentCode = code;
            document.getElementById('selected_code_display').innerText = code;
            document.getElementById('add_new_btn').disabled = false;
            
            // å±¥æ­´ãƒªã‚¹ãƒˆã‚’å–å¾—
            const res = await fetch(`/get_history/${code}`);
            const list = await res.json();
            
            const listEl = document.getElementById('history_list');
            listEl.innerHTML = ""; // ã‚¯ãƒªã‚¢
            
            if (list.length === 0) {
                listEl.innerHTML = '<p class="text-xs text-gray-400 text-center">å±¥æ­´ãªã—</p>';
                return;
            }

            // å±¥æ­´ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
            list.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-2 rounded text-sm hover:bg-white border border-transparent hover:border-gray-200 transition mb-1 " + (index === 0 ? "bg-blue-50 border-blue-100 font-bold" : "text-gray-600");
                btn.innerHTML = `ğŸ“… ${item.date}`;
                btn.onclick = () => loadLogDetail(item.id);
                listEl.appendChild(btn);
            });

            // æœ€æ–°ã®ãƒ­ã‚°ã‚’è‡ªå‹•ãƒ­ãƒ¼ãƒ‰
            if(list.length > 0) loadLogDetail(list[0].id);
        }

        // å±¥æ­´è©³ç´°ã®ãƒ­ãƒ¼ãƒ‰
        async function loadLogDetail(id) {
            try {
                const res = await fetch(`/get_log/${id}`);
                if (!res.ok) return;
                const data = await res.json();
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
                document.getElementById('log_id').value = data.id;
                document.getElementById('code').value = data.code;
                document.getElementById('name').value = data.name || "";
                document.getElementById('holding_qty').value = data.holding_qty || "";
                document.getElementById('avg_cost').value = data.avg_cost || "";
                document.getElementById('target_buy').value = data.target_buy || "";
                document.getElementById('target_sell').value = data.target_sell || "";
                document.getElementById('memo').value = data.memo || "";
                document.getElementById('analysis_memo').value = data.analysis_memo || "";
                document.getElementById('urls').value = data.urls || "";

                // ç”»åƒçŠ¶æ…‹
                const setImg = (eid, has) => {
                    const el = document.getElementById(eid);
                    el.innerText = has ? "âœ… æ¸ˆ" : "æœª";
                    el.className = has ? "text-green-600 font-bold mt-1" : "text-gray-300 mt-1";
                };
                setImg('s_daily', data.has_daily);
                setImg('s_5min', data.has_5min);
                setImg('s_board', data.has_board);

                // ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡
                document.getElementById('delete_btn').classList.remove('hidden');
                document.getElementById('copy_btn').classList.remove('hidden');
                
            } catch(e) { console.error(e); }
        }

        // æ–°è¦ä½œæˆï¼ˆç¾åœ¨é¸æŠä¸­ã®éŠ˜æŸ„ã§ï¼‰
        function createNewLogForStock() {
            if(!currentCode) return;
            document.getElementById('log_id').value = ""; // IDã‚’ç©ºã«ã™ã‚‹ï¼æ–°è¦æ‰±ã„
            // éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã¨åå‰ä»¥å¤–ã‚’ã‚¯ãƒªã‚¢
            // document.getElementById('memo').value = ""; // ãƒ¡ãƒ¢ã¯æ®‹ã™ï¼Ÿæ¶ˆã™ï¼Ÿä»Šå›ã¯æ¶ˆã™
            // æ—¥ä»˜ãŒå¤‰ã‚ã‚‹ã®ã§æ–°è¦ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜ã•ã‚Œã‚‹
            alert("âœ¨ æ–°ã—ã„æ—¥æ™‚ã§è¨˜éŒ²ã‚’ä½œæˆã—ã¾ã™ã€‚\nå†…å®¹ã‚’å…¥åŠ›ã—ã¦ã€Œä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            document.getElementById('memo').value = "";
            document.getElementById('analysis_memo').value = "";
            document.getElementById('copy_btn').classList.add('hidden');
            document.getElementById('delete_btn').classList.add('hidden');
        }

        // å®Œå…¨æ–°è¦ä½œæˆ
        function createNewLog() {
            currentCode = "";
            document.getElementById('history_list').innerHTML = "";
            document.getElementById('log_id').value = "";
            document.getElementById('code').value = "";
            document.getElementById('name').value = "";
            document.getElementById('memo').value = "";
            // å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¯ãƒªã‚¢...
            ['holding_qty','avg_cost','target_buy','target_sell','urls','analysis_memo'].forEach(id => document.getElementById(id).value="");
            
            document.getElementById('copy_btn').classList.add('hidden');
            document.getElementById('delete_btn').classList.add('hidden');
        }

        // å‰Šé™¤
        function deleteLog() {
            const id = document.getElementById('log_id').value;
            if(!id) return;
            if(confirm("ã“ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                document.getElementById('delete_log_id').value = id;
                document.getElementById('deleteForm').submit();
            }
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
        async function copyDataToClipboard() {
            const id = document.getElementById('log_id').value;
            if(!id) return;
            const res = await fetch(`/download_notebooklm/${id}`);
            if(res.ok) {
                const text = await res.text();
                await navigator.clipboard.writeText(text);
                alert("âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
            }
        }

        function preview(input, id) {
            if(input.files[0]) {
                const el = document.getElementById(id);
                el.innerText = "âœ… é¸æŠ";
                el.className = "text-blue-600 font-bold mt-1";
            }
        }
    </script>
</body>
</html>
