<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ªå¼ãƒˆãƒ¬ãƒ¼ãƒ‰æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-4xl mx-auto pb-24">

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6">
                {% for category, message in messages %}
                    <div class="p-4 mb-2 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <header class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold flex items-center gap-2 mb-1">
                <span class="text-red-500 text-3xl">ğŸ“ˆ</span> æ ªå¼ãƒˆãƒ¬ãƒ¼ãƒ‰æ”¯æ´ãƒ„ãƒ¼ãƒ«
            </h1>
            <p class="text-xs text-gray-500">v3.0 ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼†PDFå¯¾å¿œç‰ˆ</p>
        </div>
        
        <button onclick="openModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition flex items-center gap-2">
            <span>ğŸ“ éŠ˜æŸ„æƒ…å ±ã‚’ç™»éŒ²ãƒ»ç·¨é›†</span>
        </button>
    </header>

    <section class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row items-center gap-4">
        <label class="font-bold whitespace-nowrap text-gray-700">ç™»éŒ²æ¸ˆã¿éŠ˜æŸ„ã‚’å‘¼ã³å‡ºã™:</label>
        <select id="stockSelector" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-lg font-bold" onchange="loadStockInfo(this.value)">
            {% if not registered_envs %}
                <option value="">(ç™»éŒ²ã•ã‚ŒãŸéŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“)</option>
            {% endif %}
            {% for code, data in registered_envs.items() %}
                <option value="{{ code }}">{{ code }} : {{ data.name }}</option>
            {% endfor %}
        </select>
    </section>

    <section class="bg-white rounded-xl p-6 shadow-sm border border-red-200 mb-8">
        <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-red-600">
            <span>âš¡</span> AIã‚¸ãƒ£ãƒƒã‚¸ (5åˆ†è¶³+æ¿)
        </h2>
        <form action="{{ url_for('judge') }}" method="POST" enctype="multipart/form-data" class="space-y-4" onsubmit="showLoader()">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ (è‡ªå‹•å…¥åŠ›)</label>
                <input type="text" name="stock_code" id="judge_code" value="{{ form_values.stock_code if form_values else '' }}" class="w-full bg-gray-100 border p-3 rounded font-bold text-xl tracking-wider" required readonly>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="border border-dashed border-gray-300 rounded p-4 text-center hover:bg-gray-50 transition">
                    <label class="block text-sm font-bold text-gray-600 mb-2 cursor-pointer">
                        ğŸ“‰ 5åˆ†è¶³ãƒãƒ£ãƒ¼ãƒˆ
                        <input type="file" name="chart_image" accept="image/*" class="hidden" onchange="previewFile(this, 'chartPreview')">
                    </label>
                    <div id="chartPreview" class="text-xs text-gray-400">æœªé¸æŠ</div>
                </div>
                <div class="border border-dashed border-gray-300 rounded p-4 text-center hover:bg-gray-50 transition">
                    <label class="block text-sm font-bold text-gray-600 mb-2 cursor-pointer">
                        ğŸ“Š æ¿æƒ…å ± (æ°—é…å€¤)
                        <input type="file" name="orderbook_image" accept="image/*" class="hidden" onchange="previewFile(this, 'boardPreview')">
                    </label>
                    <div id="boardPreview" class="text-xs text-gray-400">æœªé¸æŠ</div>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ä»Šå›ã®è£œè¶³ãƒ¡ãƒ¢</label>
                <textarea name="extra_note" class="w-full border p-2 rounded h-20 text-sm" placeholder="ä¾‹: 3365å††ã®å£²ã‚Šæ¿ãŒåšã„æ°—ãŒã™ã‚‹...">{{ form_values.extra_note if form_values else '' }}</textarea>
            </div>
            
            <div id="daily_chart_indicator" class="text-sm text-gray-400 text-center py-2 bg-gray-50 rounded">
                (æ—¥è¶³ç”»åƒæƒ…å ±: æœªãƒ­ãƒ¼ãƒ‰)
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2 text-lg">
                <span>AIåˆ¤å®šå®Ÿè¡Œ</span>
                <div class="loader" id="loadingSpinner"></div>
            </button>
        </form>
    </section>

    {% if judge_result %}
    <section class="bg-blue-50 rounded-xl p-6 shadow-md border-2 border-blue-200 mb-8 animate-fade-in">
        <h2 class="font-bold text-xl mb-4 text-blue-800">ğŸ¤– AIã®åˆ¤å®šçµæœ</h2>
        <div class="prose max-w-none text-sm md:text-base bg-white p-4 rounded-lg border border-blue-100">
            {{ judge_result | safe }}
        </div>
        <div class="mt-4 text-center">
            <a href="{{ url_for('index') }}" class="text-blue-600 underline text-sm hover:text-blue-800">çµæœã‚’ã‚¯ãƒªã‚¢</a>
        </div>
    </section>
    {% endif %}


    <div id="envModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="closeModal()"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b mb-4">
                    <p class="text-2xl font-bold text-green-700">ğŸ“ ç’°å¢ƒæƒ…å ±ã®ç™»éŒ²ãƒ»æ›´æ–°</p>
                    <div class="modal-close cursor-pointer z-50" onclick="closeModal()">âœ–</div>
                </div>

                <form action="{{ url_for('register_stock') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ *</label>
                            <input type="text" name="reg_code" id="reg_code" placeholder="ä¾‹: 9984" class="w-full border-2 border-gray-200 p-2 rounded focus:border-green-500 focus:outline-none" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">éŠ˜æŸ„å</label>
                            <input type="text" name="reg_name" id="reg_name" placeholder="ä¾‹: ã‚½ãƒ•ãƒãƒ³" class="w-full border-2 border-gray-200 p-2 rounded focus:border-green-500 focus:outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 bg-yellow-50 p-3 rounded border border-yellow-200">
                        <div>
                            <label class="block text-xs font-bold text-yellow-800 mb-1">ä¿æœ‰æ ªæ•°</label>
                            <input type="number" name="reg_holding_qty" id="reg_holding_qty" value="0" class="w-full border p-2 rounded text-right">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-yellow-800 mb-1">å¹³å‡å–å¾—å˜ä¾¡ (å††)</label>
                            <input type="number" name="reg_avg_cost" id="reg_avg_cost" value="0" class="w-full border p-2 rounded text-right">
                        </div>
                    </div>

                    <div class="bg-green-50 p-3 rounded border border-green-100">
                        <label class="block text-xs font-bold text-green-800 mb-1">â‘  æ—¥è¶³ãƒãƒ£ãƒ¼ãƒˆ (ç”»åƒ)</label>
                        <input type="file" name="reg_daily_chart" accept="image/*" class="text-xs w-full text-gray-600">
                        <p class="text-xs text-green-600 mt-1 font-bold" id="modal_daily_status">â€»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ä¸Šæ›¸ãä¿å­˜</p>
                    </div>

                    <div class="bg-gray-50 p-3 rounded border border-gray-100">
                        <label class="block text-xs font-bold text-gray-500 mb-1">â‘¡ æ±ºç®—æ›¸ãƒ»é©æ™‚é–‹ç¤º (PDF ã¾ãŸã¯ ç”»åƒ)</label>
                        <input type="file" name="reg_financial_file" accept="image/*,.pdf" class="text-xs w-full text-gray-600">
                        <div class="flex gap-4 mt-2 text-xs">
                            <label class="flex items-center"><input type="radio" name="financial_mode" value="append" checked class="mr-1"> è¿½åŠ ä¿å­˜</label>
                            <label class="flex items-center"><input type="radio" name="financial_mode" value="overwrite" class="mr-1"> å…¨ä¸Šæ›¸ã</label>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">â€»PDFã‚‚é¸æŠå¯èƒ½ã§ã™</p>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">â‘¢ å‚è€ƒãƒ‹ãƒ¥ãƒ¼ã‚¹URL</label>
                        <textarea name="reg_urls" placeholder="http://..." class="w-full border p-2 rounded h-16 text-xs"></textarea>
                        <div class="flex gap-4 mt-1 text-xs text-gray-600">
                            <label class="flex items-center"><input type="radio" name="news_mode" value="append" checked class="mr-1"> è¿½åŠ ä¿å­˜</label>
                            <label class="flex items-center"><input type="radio" name="news_mode" value="overwrite" class="mr-1"> å…¨ä¸Šæ›¸ã</label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">â‘£ è‡ªç”±ãƒ¡ãƒ¢</label>
                        <textarea name="reg_memo" id="reg_memo" placeholder="ç›£è¦–ä¸­ã®ãƒã‚¤ãƒ³ãƒˆãªã©" class="w-full border p-2 rounded h-20 text-xs"></textarea>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="button" onclick="closeModal()" class="bg-transparent border border-gray-500 text-gray-500 hover:bg-gray-100 font-bold py-2 px-4 rounded mr-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow">ä¿å­˜ã™ã‚‹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function openModal() {
            const modal = document.getElementById('envModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            const modal = document.getElementById('envModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        function showLoader() {
            const btn = document.getElementById('submitBtn');
            const spinner = document.getElementById('loadingSpinner');
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            spinner.style.display = 'block';
            btn.querySelector('span').innerText = 'åˆ†æä¸­...';
        }

        function previewFile(input, targetId) {
            const display = document.getElementById(targetId);
            if(input.files && input.files[0]) {
                display.innerText = "é¸æŠä¸­: " + input.files[0].name;
                display.classList.add('text-blue-600', 'font-bold');
            }
        }

        async function loadStockInfo(code) {
            if (!code) return;
            document.getElementById('judge_code').value = code;

            try {
                const response = await fetch(`/get_stock/${code}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('reg_code').value = code;
                    document.getElementById('reg_name').value = data.name || "";
                    document.getElementById('reg_memo').value = data.memo || "";
                    document.getElementById('reg_holding_qty').value = data.holding_qty || "0";
                    document.getElementById('reg_avg_cost').value = data.avg_cost || "0";
                    
                    const indicator = document.getElementById('daily_chart_indicator');
                    const modalStatus = document.getElementById('modal_daily_status');

                    if (data.has_daily_chart) {
                        indicator.innerText = "âœ… æ—¥è¶³ãƒãƒ£ãƒ¼ãƒˆ: ç™»éŒ²æ¸ˆã¿";
                        indicator.className = "text-sm text-center py-2 bg-green-100 text-green-700 font-bold rounded";
                        modalStatus.innerText = "âœ… ç™»éŒ²æ¸ˆã¿ã®æ—¥è¶³ç”»åƒã‚ã‚Šï¼ˆä¸Šæ›¸ãå¯èƒ½ï¼‰";
                    } else {
                        indicator.innerText = "âš ï¸ æ—¥è¶³ãƒãƒ£ãƒ¼ãƒˆ: æœªç™»éŒ²";
                        indicator.className = "text-sm text-center py-2 bg-gray-50 text-gray-400 rounded";
                        modalStatus.innerText = "â€»ã¾ã ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“";
                    }
                }
            } catch (e) {
                console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼", e);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('stockSelector');
            if(selector.value) loadStockInfo(selector.value);
        });
    </script>
</body>
</html>
