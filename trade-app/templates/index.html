<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ªå¼ãƒˆãƒ¬ãƒ¼ãƒ‰æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-8 max-w-4xl mx-auto pb-24">

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6">
                {% for category, message in messages %}
                    <div class="p-4 mb-2 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <header class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold flex items-center gap-2 mb-1">
                <span class="text-red-500 text-3xl">ğŸ“ˆ</span> æ ªå¼ãƒˆãƒ¬ãƒ¼ãƒ‰æ”¯æ´ãƒ„ãƒ¼ãƒ«
            </h1>
            <p class="text-xs text-gray-500">v3.5 å®Œå…¨å‹•ä½œç‰ˆ</p>
        </div>
        
        <button onclick="openNewModal()" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition flex justify-center items-center gap-2">
            <span>âœ¨ æ–°è¦éŠ˜æŸ„ã‚’è¿½åŠ </span>
        </button>
    </header>

    <section class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
        <label class="font-bold whitespace-nowrap text-gray-700 block mb-2">ç™»éŒ²æ¸ˆã¿éŠ˜æŸ„ã‚’å‘¼ã³å‡ºã™:</label>
        <div class="flex flex-col md:flex-row gap-2">
            <select id="stockSelector" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-lg font-bold" onchange="loadStockInfo(this.value)">
                {% if not registered_envs %}
                    <option value="">(ç™»éŒ²ã•ã‚ŒãŸéŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“)</option>
                {% endif %}
                {% for code, data in registered_envs.items() %}
                    <option value="{{ code }}">{{ code }} : {{ data.name }}</option>
                {% endfor %}
            </select>
            <button onclick="openEditModal()" class="w-full md:w-auto whitespace-nowrap bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg transition">
                ğŸ“ ç·¨é›†
            </button>
        </div>
    </section>

    <section class="bg-white rounded-xl p-6 shadow-sm border border-red-200 mb-8">
        <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-red-600">
            <span>âš¡</span> AIã‚¸ãƒ£ãƒƒã‚¸ (5åˆ†è¶³+æ¿)
        </h2>
        <form action="{{ url_for('judge') }}" method="POST" enctype="multipart/form-data" class="space-y-4" onsubmit="showLoader()">
            
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">å¯¾è±¡éŠ˜æŸ„ (è‡ªå‹•å…¥åŠ›)</label>
                <input type="text" name="stock_code" id="judge_code" value="{{ form_values.stock_code if form_values else '' }}" class="w-full bg-gray-100 border p-3 rounded font-bold text-xl tracking-wider text-center" required readonly placeholder="ä¸Šã®ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition cursor-pointer relative" onclick="document.getElementById('chart_input').click()">
                    <span class="text-3xl block mb-2">ğŸ“‰</span>
                    <label class="block text-sm font-bold text-gray-600 cursor-pointer">5åˆ†è¶³ãƒãƒ£ãƒ¼ãƒˆ</label>
                    <input type="file" id="chart_input" name="chart_image" accept="image/*" class="hidden" onchange="previewFile(this, 'chartPreview')">
                    <div id="chartPreview" class="text-xs text-blue-500 mt-2 font-bold truncate">æœªé¸æŠ</div>
                </div>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition cursor-pointer relative" onclick="document.getElementById('board_input').click()">
                    <span class="text-3xl block mb-2">ğŸ“Š</span>
                    <label class="block text-sm font-bold text-gray-600 cursor-pointer">æ¿æƒ…å ± (æ°—é…)</label>
                    <input type="file" id="board_input" name="orderbook_image" accept="image/*" class="hidden" onchange="previewFile(this, 'boardPreview')">
                    <div id="boardPreview" class="text-xs text-blue-500 mt-2 font-bold truncate">æœªé¸æŠ</div>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ä»Šå›ã®æ°—ä»˜ããƒ»ãƒ¡ãƒ¢</label>
                <textarea name="extra_note" class="w-full border p-3 rounded-lg h-20 text-sm" placeholder="ä¾‹: 3365å††ã«å¤§ããªå£²ã‚Šæ¿ãŒã‚ã‚‹...">{{ form_values.extra_note if form_values else '' }}</textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-2 text-xs md:text-sm">
                <div id="daily_chart_indicator" class="text-gray-400 text-center py-2 bg-gray-50 rounded font-bold border">
                    æ—¥è¶³ç”»åƒ: æœªç™»éŒ²
                </div>
                <div id="financial_indicator" class="text-gray-400 text-center py-2 bg-gray-50 rounded font-bold border">
                    æ±ºç®—æƒ…å ±: æœªç™»éŒ²
                </div>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2 text-lg transition transform active:scale-95">
                <span>ğŸ¤– AIã§å£²è²·åˆ¤æ–­ã™ã‚‹</span>
                <div class="loader" id="loadingSpinner"></div>
            </button>
        </form>
    </section>

    {% if judge_result %}
    <section class="bg-white rounded-xl shadow-lg border-2 border-blue-100 overflow-hidden mb-8 fade-in">
        <div class="bg-blue-50 px-6 py-4 border-b border-blue-100 flex justify-between items-center">
            <h2 class="font-bold text-xl text-blue-900 flex items-center gap-2">
                <span>ğŸ¤–</span> AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ
            </h2>
            <a href="{{ url_for('index') }}" class="text-xs bg-white border border-blue-300 text-blue-600 px-3 py-1 rounded-full hover:bg-blue-600 hover:text-white transition">ã‚¯ãƒªã‚¢</a>
        </div>
        <div class="p-6">
            {{ judge_result | safe }}
        </div>
    </section>
    {% endif %}

    <div id="envModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-60" onclick="closeModal()"></div>
        
        <div class="bg-white w-full md:max-w-2xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b sticky top-0 bg-white z-10">
                <p class="text-xl font-bold text-gray-800" id="modalTitle">ğŸ“ éŠ˜æŸ„æƒ…å ±ã®ç™»éŒ²</p>
                <button class="text-gray-400 hover:text-gray-600 text-2xl" onclick="closeModal()">Ã—</button>
            </div>

            <div class="p-6">
                <form action="{{ url_for('register_stock') }}" method="POST" enctype="multipart/form-data" class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ *</label>
                            <input type="text" name="reg_code" id="reg_code" placeholder="ä¾‹: 9984" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-green-500 focus:outline-none font-bold text-lg" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">éŠ˜æŸ„å</label>
                            <input type="text" name="reg_name" id="reg_name" placeholder="ä¾‹: ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯G" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-green-500 focus:outline-none">
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-yellow-800 mb-1">ä¿æœ‰æ ªæ•°</label>
                            <input type="number" name="reg_holding_qty" id="reg_holding_qty" value="0" class="w-full border border-yellow-300 p-2 rounded text-right bg-white">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-yellow-800 mb-1">å¹³å‡å–å¾—å˜ä¾¡ (å††)</label>
                            <input type="number" name="reg_avg_cost" id="reg_avg_cost" value="0" class="w-full border border-yellow-300 p-2 rounded text-right bg-white">
                        </div>
                    </div>

                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <label class="block text-sm font-bold text-green-800 mb-2">â‘  æ—¥è¶³ãƒãƒ£ãƒ¼ãƒˆ (ç’°å¢ƒèªè­˜ç”¨)</label>
                        <input type="file" name="reg_daily_chart" id="reg_daily_chart" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200">
                        <p class="text-xs text-green-600 mt-2 font-bold" id="modal_daily_status">â€»æ–°è¦ç™»éŒ²</p>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label class="block text-sm font-bold text-gray-700 mb-2">â‘¡ æ±ºç®—æ›¸ãƒ»é©æ™‚é–‹ç¤º (PDF/ç”»åƒ)</label>
                            <input type="file" name="reg_financial_file" id="reg_financial_file" accept="image/*,.pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300">
                            <p class="text-xs text-blue-600 mt-2 font-bold" id="modal_financial_status">â€»æœªç™»éŒ²</p>
                            <div class="mt-2 flex gap-4 text-xs">
                                <label class="flex items-center cursor-pointer"><input type="radio" name="financial_mode" value="append" checked class="mr-1">è¿½åŠ ä¿å­˜</label>
                                <label class="flex items-center cursor-pointer"><input type="radio" name="financial_mode" value="overwrite" class="mr-1">ä¸Šæ›¸ã</label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">â‘¢ å‚è€ƒãƒ‹ãƒ¥ãƒ¼ã‚¹URL (æ”¹è¡Œã§è¤‡æ•°å¯)</label>
                            <textarea name="reg_urls" id="reg_urls" placeholder="https://..." class="w-full border p-3 rounded-lg h-24 text-xs font-mono"></textarea>
                            <div class="mt-1 flex gap-4 text-xs text-gray-500">
                                <label class="flex items-center cursor-pointer"><input type="radio" name="news_mode" value="append" checked class="mr-1">è¿½åŠ </label>
                                <label class="flex items-center cursor-pointer"><input type="radio" name="news_mode" value="overwrite" class="mr-1">ä¸Šæ›¸ã</label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">â‘£ è‡ªç”±ãƒ¡ãƒ¢</label>
                        <textarea name="reg_memo" id="reg_memo" placeholder="ç›£è¦–ãƒã‚¤ãƒ³ãƒˆãªã©..." class="w-full border p-3 rounded-lg h-20 text-sm"></textarea>
                    </div>

                    <div class="flex justify-end pt-4 gap-3 sticky bottom-0 bg-white pb-2">
                        <button type="button" onclick="closeModal()" class="py-3 px-6 rounded-lg text-gray-500 font-bold hover:bg-gray-100 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition">ä¿å­˜ã™ã‚‹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function openModal() {
            const modal = document.getElementById('envModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            const modal = document.getElementById('envModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        function openNewModal() {
            document.getElementById('modalTitle').innerText = "âœ¨ æ–°è¦éŠ˜æŸ„ã®ç™»éŒ²";
            document.getElementById('reg_code').value = "";
            document.getElementById('reg_name').value = "";
            document.getElementById('reg_holding_qty').value = "0";
            document.getElementById('reg_avg_cost').value = "0";
            document.getElementById('reg_memo').value = "";
            document.getElementById('reg_urls').value = "";
            document.getElementById('reg_daily_chart').value = "";
            document.getElementById('reg_financial_file').value = "";
            document.getElementById('modal_daily_status').innerText = "â€»æ–°è¦";
            document.getElementById('modal_daily_status').className = "text-xs text-gray-400 mt-2";
            document.getElementById('modal_financial_status').innerText = "â€»æ–°è¦";
            document.getElementById('modal_financial_status').className = "text-xs text-gray-400 mt-2";
            openModal();
        }

        function openEditModal() {
            const selector = document.getElementById('stockSelector');
            const currentCode = selector.value;
            if(!currentCode) {
                alert("ç·¨é›†ã™ã‚‹éŠ˜æŸ„ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã‚“ã§ãªï¼");
                return;
            }
            // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é–‹ã
            loadStockInfo(currentCode).then(() => {
                document.getElementById('modalTitle').innerText = "ğŸ“ " + currentCode + " ã®ç·¨é›†";
                openModal();
            });
        }

        function showLoader() {
            const btn = document.getElementById('submitBtn');
            const spinner = document.getElementById('loadingSpinner');
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            spinner.style.display = 'block';
            btn.querySelector('span').innerText = 'åˆ†æä¸­...';
        }

        function previewFile(input, targetId) {
            const display = document.getElementById(targetId);
            if(input.files && input.files[0]) {
                display.innerText = "âœ… " + input.files[0].name;
                display.classList.remove('text-gray-400');
                display.classList.add('text-blue-600', 'font-bold');
            }
        }

        async function loadStockInfo(code) {
            if (!code) return;
            document.getElementById('judge_code').value = code;

            try {
                const response = await fetch(`/get_stock/${code}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('reg_code').value = code;
                    document.getElementById('reg_name').value = data.name || "";
                    document.getElementById('reg_memo').value = data.memo || "";
                    document.getElementById('reg_holding_qty').value = data.holding_qty || "0";
                    document.getElementById('reg_avg_cost').value = data.avg_cost || "0";
                    document.getElementById('reg_urls').value = data.saved_urls || "";
                    
                    const dailyInd = document.getElementById('daily_chart_indicator');
                    const modalDaily = document.getElementById('modal_daily_status');
                    if (data.has_daily_chart) {
                        dailyInd.innerText = "âœ… æ—¥è¶³: ç™»éŒ²æ¸ˆ";
                        dailyInd.className = "text-center py-2 bg-green-100 text-green-800 font-bold rounded border border-green-200";
                        modalDaily.innerText = "âœ… ç™»éŒ²æ¸ˆã¿ç”»åƒã‚ã‚Š (ä¸Šæ›¸ãå¯)";
                        modalDaily.className = "text-xs text-green-600 mt-2 font-bold";
                    } else {
                        dailyInd.innerText = "âš ï¸ æ—¥è¶³: æœªç™»éŒ²";
                        dailyInd.className = "text-center py-2 bg-gray-100 text-gray-400 rounded border border-gray-200";
                        modalDaily.innerText = "â€»æœªç™»éŒ²";
                        modalDaily.className = "text-xs text-gray-400 mt-2";
                    }

                    const finInd = document.getElementById('financial_indicator');
                    const modalFin = document.getElementById('modal_financial_status');
                    if (data.has_financial_info) {
                        finInd.innerText = "âœ… æ±ºç®—: ã‚ã‚Š";
                        finInd.className = "text-center py-2 bg-green-100 text-green-800 font-bold rounded border border-green-200";
                        modalFin.innerText = "âœ… ç™»éŒ²æ¸ˆã¿æƒ…å ±ã‚ã‚Š (ä¸Šæ›¸ãå¯)";
                        modalFin.className = "text-xs text-green-600 mt-2 font-bold";
                    } else {
                        finInd.innerText = "âš ï¸ æ±ºç®—: æœªç™»éŒ²";
                        finInd.className = "text-center py-2 bg-gray-100 text-gray-400 rounded border border-gray-200";
                        modalFin.innerText = "â€»æœªç™»éŒ²";
                        modalFin.className = "text-xs text-gray-400 mt-2";
                    }
                }
            } catch (e) {
                console.error("Fetch error:", e);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('stockSelector');
            if(selector.value) loadStockInfo(selector.value);
        });
    </script>
</body>
</html>
