<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>çŸ­æœŸãƒˆãƒ¬ãƒ¼ãƒ‰AIåˆ¤å®šãƒ„ãƒ¼ãƒ«ï¼ˆç’°å¢ƒè¨˜æ†¶ã¤ãï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #222;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 18px;
      margin: 16px 0 8px;
    }
    p {
      margin: 4px 0;
      line-height: 1.6;
      font-size: 14px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin: 8px 0 4px;
    }
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }
    input[type="file"] {
      width: 100%;
      margin-top: 4px;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .btn-primary {
      background: #007aff;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e5ea;
      color: #111;
    }
    .btn-full {
      width: 100%;
      justify-content: center;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eee;
      margin-left: 4px;
    }
    .status-ok {
      color: #0a7c0a;
    }
    .status-ng {
      color: #c00;
    }
    .result-box {
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      background: #f0f9ff;
      border: 1px solid #cce7ff;
      font-size: 14px;
    }
    .result-title {
      font-weight: 700;
      margin-bottom: 4px;
    }
    .range-info {
      font-size: 13px;
      margin-top: 6px;
    }
    .env-alert {
      font-size: 12px;
      color: #666;
    }
    .env-message {
      font-size: 13px;
      color: #0a7c0a;
      margin-top: 4px;
    }
    .error-message {
      font-size: 13px;
      color: #c00;
      margin-top: 4px;
    }
    .section-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .small-note {
      font-size: 11px;
      color: #666;
    }
    .flex-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .flex-1 {
      flex: 1 1 0;
      min-width: 0;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal {
      background: #fff;
      border-radius: 16px;
      max-width: 540px;
      width: calc(100% - 32px);
      padding: 16px 18px 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.18);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 700;
    }
    .modal-close {
      border-radius: 999px;
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #f2f2f7;
      cursor: pointer;
      font-size: 18px;
    }
    .modal-body {
      font-size: 14px;
      max-height: 60vh;
      overflow-y: auto;
      padding-top: 4px;
    }
    .modal-body p {
      margin-bottom: 6px;
    }
    @media (min-width: 768px) {
      h1 {
        font-size: 22px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>çŸ­æœŸãƒˆãƒ¬ãƒ¼ãƒ‰AIåˆ¤å®šãƒ„ãƒ¼ãƒ«ï¼ˆç’°å¢ƒè¨˜æ†¶ã¤ãï¼‰</h1>
  <p>éŠ˜æŸ„ã”ã¨ã«ã€Œæ—¥è¶³ãƒ»ææ–™ãªã©ã®ç’°å¢ƒæƒ…å ±ã€ã‚’ç™»éŒ²ã—ã¦ãŠãã¨ã€5åˆ†è¶³ï¼‹æ¿ã®åˆ¤å®šæ™‚ã«æ¯å›ãã‚Œã‚’è€ƒæ…®ã—ã¦ãã‚Œã¾ã™ã€‚</p>
  <p class="small-note">â€»ã‚µãƒ¼ãƒãƒ¼ã«ç”»åƒã‚„è¦ç´„ã‚’ä¿å­˜ã™ã‚‹ã®ã§ã€å€‹äººæƒ…å ±ã‚„æ©Ÿå¯†ã«é–¢ã‚ã‚‹ç”»åƒã¯ã‚¢ãƒƒãƒ—ã—ãªã„ã§ãã ã•ã„ã€‚</p>

  <!-- éŠ˜æŸ„é¸æŠãƒ»ä¸€è¦§ã‚¨ãƒªã‚¢ -->
  <div class="card">
    <div class="section-title">éŠ˜æŸ„ã‚’é¸æŠ / å…¥åŠ›</div>
    <label>ç™»éŒ²æ¸ˆã¿éŠ˜æŸ„ã‹ã‚‰é¸æŠï¼ˆä»»æ„ãƒ»ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ–¹å¼ï¼‰</label>
    <select id="saved-symbol-select">
      <option value="">ç™»éŒ²æ¸ˆã¿éŠ˜æŸ„ã‚’é¸æŠï¼ˆæœªé¸æŠï¼‰</option>
      {% for item in env_list %}
      <option value="{{ item.symbol }}"
        {% if selected_symbol and item.symbol == selected_symbol %}selected{% endif %}>
        {{ item.symbol }}{% if item.name %} {{ item.name }}{% endif %}
      </option>
      {% endfor %}
    </select>

    <label style="margin-top:10px;">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥å…¥åŠ›ï¼ˆä¾‹: 6954ï¼‰</label>
    <input
      type="text"
      id="symbol-input"
      placeholder="ä¾‹: 6954"
      value="{{ selected_symbol or '' }}"
    />
    <p class="small-note">ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§é¸ã‚“ã§ã‚‚ã€ã“ã“ã«ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ã§å…¥ã‚Šã¾ã™ã€‚ã“ã®å€¤ãŒåˆ¤å®šãƒ»ç’°å¢ƒç™»éŒ²ã®å¯¾è±¡éŠ˜æŸ„ã«ãªã‚Šã¾ã™ã€‚</p>

    <button type="button" class="btn-secondary btn-full" id="show-symbol-detail-btn">
      é¸æŠä¸­ã®éŠ˜æŸ„ã®ç’°å¢ƒã‚µãƒãƒªã‚’è¦‹ã‚‹
    </button>

    {% if env_list %}
      <p class="env-alert">ç™»éŒ²æ¸ˆã¿éŠ˜æŸ„: {{ env_list|length }} ä»¶</p>
    {% else %}
      <p class="env-alert">ã¾ã ç’°å¢ƒæƒ…å ±ã‚’ç™»éŒ²ã—ãŸéŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸‹ã®ã€Œæ—¥è¶³ãƒ»ææ–™ãªã©ã®ç’°å¢ƒæƒ…å ±ã‚’ç™»éŒ²ã€ã‹ã‚‰è¿½åŠ ã§ãã¾ã™ã€‚</p>
    {% endif %}
  </div>

  <!-- 2. 5åˆ†è¶³ï¼‹æ¿ã‹ã‚‰çŸ­æœŸã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¤å®šï¼ˆé »åº¦é«˜ã„æ–¹ã‚’ä¸Šã«ï¼‰ -->
  <div class="card">
    <div class="section-title">2. 5åˆ†è¶³ï¼‹æ¿ã‹ã‚‰çŸ­æœŸã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¤å®š</div>
    <p class="small-note">
      ç›´è¿‘ã®5åˆ†è¶³ãƒãƒ£ãƒ¼ãƒˆã¨ã€ç¾åœ¨ã®æ¿ï¼ˆæ°—é…å€¤ï¼‰ã®ã‚¹ã‚¯ã‚·ãƒ§ã‚’ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨ã€<br>
      <strong>BUY / SELL / HOLD</strong> ã¨ç°¡å˜ãªç†ç”±ã€ã‚ã‚Œã°ã€Œè²·ã†ãƒ»å£²ã‚‹ç‹™ã„ç›®ãƒ¬ãƒ³ã‚¸ã€ã‚‚å‡ºã—ã¾ã™ã€‚
    </p>

    <form method="post" enctype="multipart/form-data" id="judge-form">
      <input type="hidden" name="mode" value="judge" />
      <input type="hidden" name="symbol_judge" id="symbol-judge-hidden" />

      <label>5åˆ†è¶³ãƒãƒ£ãƒ¼ãƒˆç”»åƒï¼ˆå¿…é ˆï¼‰</label>
      <input type="file" name="chart_image" accept="image/*" />

      <label>ç¾åœ¨ã®æ¿ï¼ˆæ°—é…å€¤ï¼‰ã®ç”»åƒï¼ˆå¿…é ˆï¼‰</label>
      <input type="file" name="board_image" accept="image/*" />

      <label>è£œè¶³ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <textarea name="memo" placeholder="ä¾‹: æ±ºç®—ç›´å¾Œ, GUã‚¹ã‚¿ãƒ¼ãƒˆ, çŸ­æœŸã§100å††æŠœãã‚’ç‹™ã„ãŸã„ ãªã©"></textarea>

      <button type="submit" class="btn-primary btn-full" style="margin-top:12px;">
        çŸ­æœŸAIã«åˆ¤å®šã—ã¦ã‚‚ã‚‰ã†
      </button>
    </form>

    {% if result %}
      <div class="result-box">
        <div class="result-title">
          ç¾åœ¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
          {% if result.action == "BUY" %}
            <span class="status-ok">BUYï¼ˆè²·ã„å¯„ã‚Šï¼‰</span>
          {% elif result.action == "SELL" %}
            <span class="status-ng">SELLï¼ˆå£²ã‚Šå¯„ã‚Šï¼‰</span>
          {% else %}
            <span>HOLDï¼ˆæ§˜å­è¦‹ï¼‰</span>
          {% endif %}
        </div>
        <div>ç†ç”±: {{ result.reason }}</div>

        {% if result.buy_range %}
          <div class="range-info">ğŸ’¹ è²·ã†ãªã‚‰ã“ã®ã‚ãŸã‚Š: {{ result.buy_range }}</div>
        {% endif %}
        {% if result.sell_range %}
          <div class="range-info">ğŸ’° å£²ã‚‹ãªã‚‰ã“ã®ã‚ãŸã‚Š: {{ result.sell_range }}</div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- 1. æ—¥è¶³ãƒ»ææ–™ãªã©ã®ç’°å¢ƒæƒ…å ±ã‚’ç™»éŒ²ï¼ˆé »åº¦ä½ã„æ–¹ã‚’ä¸‹ã«ï¼‰ -->
  <div class="card">
    <div class="section-title">1. æ—¥è¶³ãƒ»ææ–™ãªã©ã®ç’°å¢ƒæƒ…å ±ã‚’ç™»éŒ²ï¼ˆä»»æ„ãƒ»ä¸Šæ›¸ãï¼‰</div>
    <p class="small-note">
      ã“ã®éŠ˜æŸ„ã®ã€Œæ—¥è¶³ãƒãƒ£ãƒ¼ãƒˆã€ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãªã©ã®ç”»åƒã€ã€Œå‚è€ƒã«ã—ã¦ã»ã—ã„URLã€ã€Œãƒ¡ãƒ¢ã€ã‹ã‚‰ã€<br>
      AIãŒç’°å¢ƒã‚µãƒãƒªã‚’ä½œã£ã¦ä¿å­˜ã—ã¾ã™ã€‚ä¿å­˜ã•ã‚ŒãŸæƒ…å ±ã¯ä¸Šã®åˆ¤å®šæ™‚ã«è‡ªå‹•ã§è€ƒæ…®ã•ã‚Œã¾ã™ã€‚
    </p>

    <form method="post" enctype="multipart/form-data" id="env-form">
      <input type="hidden" name="mode" value="update_env" />
      <input type="hidden" name="symbol_env" id="symbol-env-hidden" />

      <label>éŠ˜æŸ„åï¼ˆä»»æ„ãƒ»ãƒ¡ãƒ¢ç”¨ï¼‰</label>
      <input type="text" name="stock_name" placeholder="ä¾‹: ãƒ•ã‚¡ãƒŠãƒƒã‚¯" />

      <label>æ—¥è¶³ãƒãƒ£ãƒ¼ãƒˆç”»åƒï¼ˆä»»æ„ãƒ»æ–°ã—ãç™»éŒ²ã™ã‚‹ã¨ä¸Šæ›¸ãï¼‰</label>
      <input type="file" name="daily_image" accept="image/*" />
      <p class="small-note">ä¸­æœŸãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã®æ—¥è¶³ã‚¹ã‚¯ã‚·ãƒ§ã€‚æœªæŒ‡å®šãªã‚‰å‰å›ã®æƒ…å ±ãŒãã®ã¾ã¾æ®‹ã‚Šã¾ã™ã€‚</p>

      <label>è¿½åŠ ã®å‚è€ƒç”»åƒï¼ˆä»»æ„ãƒ»è¤‡æ•°å¯ï¼‰</label>
      <input type="file" name="extra_images" accept="image/*" multiple />
      <p class="small-note">ä¾‹: 60åˆ†è¶³ãƒãƒ£ãƒ¼ãƒˆã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚¹ã‚¯ã‚·ãƒ§ãªã©ã€‚</p>

      <label>å‚è€ƒã«ã—ã¦ã»ã—ã„URLï¼ˆä»»æ„ãƒ»è¤‡æ•°è¡ŒOKï¼‰</label>
      <textarea name="env_urls" placeholder="1è¡Œã«1ã¤ãšã¤URLã‚’å…¥åŠ›&#10;ä¾‹: https://www.example.com/ir/..."></textarea>

      <label>ç’°å¢ƒã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <textarea name="env_memo" placeholder="ä¾‹: æ±ºç®—ã¯ç„¡é›£, ä¸­æœŸã¯ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ç¶™ç¶š, é•·æœŸã§ãƒ›ãƒ¼ãƒ«ãƒ‰ã—ãŸã„ ãªã©"></textarea>

      <button type="submit" class="btn-secondary btn-full" style="margin-top:12px;">
        ã“ã®éŠ˜æŸ„ã®ç’°å¢ƒæƒ…å ±ã‚’AIã«è¦ç´„ãƒ»ç™»éŒ²ã™ã‚‹
      </button>
    </form>

    {% if env_message %}
      <p class="env-message">{{ env_message }}</p>
    {% endif %}
  </div>

  {% if error %}
    <p class="error-message">{{ error }}</p>
  {% endif %}
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆéŠ˜æŸ„è©³ç´°ï¼‰ -->
<div class="modal-overlay" id="symbol-modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">éŠ˜æŸ„è©³ç´°</div>
      <button class="modal-close" id="modal-close-btn">Ã—</button>
    </div>
    <div class="modal-body">
      <p id="modal-updated"></p>
      <p id="modal-summary"></p>
    </div>
  </div>
</div>

<script>
  // Pythonå´ã‹ã‚‰æ¸¡ã•ã‚ŒãŸç’°å¢ƒãƒ‡ãƒ¼ã‚¿ä¸€è¦§ï¼ˆéŠ˜æŸ„ã”ã¨ã® summary ãªã©ï¼‰
  const ENV_DATA = {{ env_list | tojson }};
  const selectedSymbolFromServer = "{{ selected_symbol or '' }}";

  const symbolInput = document.getElementById("symbol-input");
  const savedSelect = document.getElementById("saved-symbol-select");
  const symbolJudgeHidden = document.getElementById("symbol-judge-hidden");
  const symbolEnvHidden = document.getElementById("symbol-env-hidden");
  const showDetailBtn = document.getElementById("show-symbol-detail-btn");

  const modalOverlay = document.getElementById("symbol-modal-overlay");
  const modalTitle = document.getElementById("modal-title");
  const modalUpdated = document.getElementById("modal-updated");
  const modalSummary = document.getElementById("modal-summary");
  const modalCloseBtn = document.getElementById("modal-close-btn");

  function findEnv(symbol) {
    return ENV_DATA.find(item => item.symbol === symbol);
  }

  function syncHiddenSymbol() {
    const v = (symbolInput.value || "").trim();
    symbolJudgeHidden.value = v;
    symbolEnvHidden.value = v;
  }

  // ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´ã§ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«åæ˜ 
  if (savedSelect) {
    savedSelect.addEventListener("change", () => {
      const sym = savedSelect.value || "";
      if (sym) {
        symbolInput.value = sym;
      }
      syncHiddenSymbol();
    });
  }

  // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®å¤‰æ›´ã‚’ hidden ã«åæ˜ 
  if (symbolInput) {
    symbolInput.addEventListener("input", syncHiddenSymbol);
  }

  // åˆæœŸåŒæœŸ
  syncHiddenSymbol();

  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  function openSymbolModal() {
    const symbol = (symbolInput.value || "").trim() || (savedSelect && savedSelect.value || "");
    if (!symbol) {
      alert("éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ç™»éŒ²æ¸ˆã¿éŠ˜æŸ„ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    const info = findEnv(symbol);
    if (!info) {
      modalTitle.textContent = symbol + " ã®ç’°å¢ƒæƒ…å ±";
      modalUpdated.textContent = "ã“ã®éŠ˜æŸ„ã®ç’°å¢ƒæƒ…å ±ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
      modalSummary.textContent = "ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ—¥è¶³ã‚„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ã“ã“ã«è¦ç´„ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
    } else {
      const namePart = info.name ? " " + info.name : "";
      modalTitle.textContent = symbol + namePart + " ã®ç’°å¢ƒæƒ…å ±";
      modalUpdated.textContent = info.updated_at
        ? "æœ€çµ‚æ›´æ–°æ—¥æ™‚: " + info.updated_at
        : "";
      modalSummary.textContent = info.summary || "è¦ç´„ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ãŒã€å†…å®¹ãŒç©ºã§ã™ã€‚";
    }
    modalOverlay.classList.add("show");
  }

  function closeSymbolModal() {
    modalOverlay.classList.remove("show");
  }

  if (showDetailBtn) {
    showDetailBtn.addEventListener("click", openSymbolModal);
  }
  if (modalCloseBtn) {
    modalCloseBtn.addEventListener("click", closeSymbolModal);
  }
  if (modalOverlay) {
    modalOverlay.addEventListener("click", (e) => {
      if (e.target === modalOverlay) {
        closeSymbolModal();
      }
    });
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚µãƒ¼ãƒå´ã§é¸ã°ã‚Œã¦ã„ãŸéŠ˜æŸ„ãŒã‚ã‚Œã° hidden åŒæœŸ
  if (selectedSymbolFromServer && !symbolInput.value) {
    symbolInput.value = selectedSymbolFromServer;
    syncHiddenSymbol();
  }

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã«ã‚‚ä¸€å¿œåŒæœŸï¼ˆå¿µã®ãŸã‚ï¼‰
  const judgeForm = document.getElementById("judge-form");
  const envForm = document.getElementById("env-form");
  if (judgeForm) {
    judgeForm.addEventListener("submit", syncHiddenSymbol);
  }
  if (envForm) {
    envForm.addEventListener("submit", syncHiddenSymbol);
  }
</script>
</body>
</html>
