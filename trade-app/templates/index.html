<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’è¦‹ã‚„ã™ã */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen pb-12">

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-11/12 max-w-lg">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-xl mb-2 flex justify-between items-center text-white font-bold {% if category == 'error' %}bg-red-500{% else %}bg-blue-600{% endif %} fade-in">
                        <span>{{ message }}</span>
                        <button onclick="this.parentElement.remove()">Ã—</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <header class="bg-white border-b px-4 py-3 shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2">
                <span>ğŸ“ˆ</span> <span class="hidden md:inline">ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ç®¡ç†</span><span class="md:hidden">ãƒˆãƒ¬ãƒ¼ãƒ‰ç®¡ç†</span>
            </h1>
            <button onclick="createNewLog()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow text-xs md:text-sm flex items-center gap-1">
                <span>ï¼‹</span><span>æ–°è¦ä½œæˆ</span>
            </button>
        </div>
    </header>

    <div class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-3 space-y-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-3 bg-gray-50 border-b font-bold text-gray-500 text-xs">ğŸ“‚ éŠ˜æŸ„ã‚’é¸æŠ</div>
                <div class="max-h-48 lg:max-h-[70vh] overflow-y-auto p-2 space-y-1">
                    {% if not registered_envs %}
                        <p class="text-xs text-center text-gray-400 py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</p>
                    {% endif %}
                    {% for code, data in registered_envs.items() %}
                        <button onclick="selectStock('{{ code }}')" class="w-full text-left p-3 rounded hover:bg-blue-50 border border-transparent hover:border-blue-100 transition group">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-blue-800">{{ code }}</span>
                                {% if data.holding_qty|int > 0 %}
                                    <span class="bg-yellow-100 text-yellow-800 text-[10px] px-2 rounded-full">ä¿æœ‰</span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-500 truncate">{{ data.name }}</div>
                        </button>
                    {% endfor %}
                </div>
            </div>

            <div id="history_section" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hidden lg:block">
                <div class="p-3 bg-gray-100 border-b font-bold text-gray-500 text-xs flex justify-between items-center">
                    <span>ğŸ•’ å±¥æ­´</span>
                    <span id="selected_code_display" class="text-blue-600"></span>
                </div>
                <div class="p-2 border-b">
                    <button onclick="createNewLogForStock()" id="add_new_btn" class="w-full bg-white border-2 border-dashed border-gray-300 text-gray-500 py-2 rounded hover:border-blue-400 hover:text-blue-500 transition text-xs font-bold disabled:opacity-50" disabled>
                        ï¼‹ ã“ã®éŠ˜æŸ„ã§è¨˜éŒ²è¿½åŠ 
                    </button>
                </div>
                <div id="history_list" class="max-h-48 lg:max-h-[calc(70vh-100px)] overflow-y-auto p-2 space-y-1">
                    <p class="text-xs text-gray-400 text-center py-2">éŠ˜æŸ„ã‚’é¸ã‚“ã§ãª</p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-9">
            <div class="bg-white rounded-xl shadow-lg border-t-4 border-blue-600 overflow-hidden">
                <form action="{{ url_for('save_data') }}" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="log_id" id="log_id">
                    
                    <div class="border-b p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-gray-50">
                        <div class="flex items-center gap-4 w-full md:w-auto">
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-gray-400">ã‚³ãƒ¼ãƒ‰</label>
                                <input type="text" name="code" id="code" class="border-b-2 border-gray-300 focus:border-blue-500 outline-none font-bold text-xl w-24 bg-transparent" placeholder="9984" required>
                            </div>
                            <div class="flex flex-col flex-1">
                                <label class="text-[10px] font-bold text-gray-400">éŠ˜æŸ„å</label>
                                <input type="text" name="name" id="name" class="border-b border-gray-200 focus:border-blue-500 outline-none w-full bg-transparent" placeholder="éŠ˜æŸ„å">
                            </div>
                        </div>
                        
                        <div class="flex gap-2 w-full md:w-auto justify-end">
                            <button type="button" id="copy_btn" onclick="copyDataToClipboard()" class="hidden bg-gray-700 hover:bg-gray-800 text-white py-2 px-4 rounded shadow text-sm flex items-center gap-2">
                                <span>ğŸ“‹</span><span class="hidden md:inline">ã‚³ãƒ”ãƒ¼</span>
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow flex items-center gap-2">
                                <span>ğŸ’¾ ä¿å­˜</span>
                            </button>
                        </div>
                    </div>

                    <div class="p-4 md:p-6 space-y-6">
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                                <h3 class="text-xs font-bold text-yellow-800 mb-2">ğŸ’° ä¿æœ‰çŠ¶æ³</h3>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" name="holding_qty" id="holding_qty" class="border p-2 rounded text-right w-full" placeholder="æ ªæ•°">
                                    <input type="number" name="avg_cost" id="avg_cost" class="border p-2 rounded text-right w-full" placeholder="å˜ä¾¡">
                                </div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                                <h3 class="text-xs font-bold text-green-800 mb-2">ğŸ¯ NotebookLM æˆ¦ç•¥</h3>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" name="target_buy" id="target_buy" class="border p-2 rounded text-center w-full" placeholder="è²·ã„ç‹™ã„">
                                    <input type="text" name="target_sell" id="target_sell" class="border p-2 rounded text-center w-full" placeholder="å£²ã‚Šç‹™ã„">
                                </div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ğŸ“ ç’°å¢ƒèªè­˜ãƒ»ãƒ¡ãƒ¢</label>
                                <textarea name="memo" id="memo" class="w-full border p-3 rounded-lg text-sm h-32 outline-none focus:border-blue-400" placeholder="æ°—ã¥ãã‚„è€ƒå¯Ÿ..."></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ğŸ¤– AIåˆ†æãƒ­ã‚°</label>
                                <textarea name="analysis_memo" id="analysis_memo" class="w-full border p-3 rounded-lg text-sm h-32 bg-green-50 border-green-200 outline-none focus:border-green-400" placeholder="AIã®å›ç­”ã‚’ã“ã“ã«ã‚³ãƒ”ãƒš..."></textarea>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-gray-500">ğŸ“¸ ãƒãƒ£ãƒ¼ãƒˆç”»åƒ</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <label class="border-2 border-dashed rounded p-2 text-center cursor-pointer hover:bg-gray-50">
                                        <span class="text-[10px] block">æ—¥è¶³</span>
                                        <input type="file" name="img_daily" class="hidden" onchange="preview(this, 's_daily')">
                                        <div id="s_daily" class="text-gray-300 text-xs">æœª</div>
                                    </label>
                                    <label class="border-2 border-dashed rounded p-2 text-center cursor-pointer hover:bg-gray-50">
                                        <span class="text-[10px] block">5åˆ†è¶³</span>
                                        <input type="file" name="img_5min" class="hidden" onchange="preview(this, 's_5min')">
                                        <div id="s_5min" class="text-gray-300 text-xs">æœª</div>
                                    </label>
                                    <label class="border-2 border-dashed rounded p-2 text-center cursor-pointer hover:bg-gray-50">
                                        <span class="text-[10px] block">æ¿</span>
                                        <input type="file" name="img_board" class="hidden" onchange="preview(this, 's_board')">
                                        <div id="s_board" class="text-gray-300 text-xs">æœª</div>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ğŸ”— ãƒ‹ãƒ¥ãƒ¼ã‚¹URL</label>
                                <textarea name="urls" id="urls" class="w-full border p-2 rounded text-xs h-20" placeholder="https://..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="bg-gray-50 p-4 border-t flex justify-end">
                    <button onclick="deleteLog()" id="delete_btn" class="hidden text-red-500 text-xs hover:bg-red-50 px-3 py-1 rounded transition">
                        ğŸ—‘ï¸ ã“ã®å±¥æ­´ã‚’å‰Šé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <form id="deleteForm" action="{{ url_for('delete_log') }}" method="POST" class="hidden">
        <input type="hidden" name="delete_log_id" id="delete_log_id">
    </form>

    <script>
        let currentCode = "";

        // ã‚¹ãƒãƒ›ã§ã‚‚å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã•ã›ã‚‹ãŸã‚ã®åˆ¶å¾¡
        function showHistorySection() {
            const section = document.getElementById('history_section');
            section.classList.remove('hidden'); // ã‚¹ãƒãƒ›ã§ã‚‚è¡¨ç¤º
            section.classList.add('block');
        }

        async function selectStock(code) {
            currentCode = code;
            document.getElementById('selected_code_display').innerText = code;
            document.getElementById('add_new_btn').disabled = false;
            
            // ã‚¹ãƒãƒ›ãªã‚‰å±¥æ­´ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºã•ã›ã‚‹
            showHistorySection();

            const res = await fetch(`/get_history/${code}`);
            const list = await res.json();
            
            const listEl = document.getElementById('history_list');
            listEl.innerHTML = "";
            
            if (list.length === 0) {
                listEl.innerHTML = '<p class="text-xs text-gray-400 text-center">å±¥æ­´ãªã—</p>';
                createNewLogForStock(); // ãƒ‡ãƒ¼ã‚¿ãªã‘ã‚Œã°æ–°è¦ãƒ¢ãƒ¼ãƒ‰ã¸
                return;
            }

            list.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-2 rounded text-sm hover:bg-blue-50 border border-transparent transition mb-1 " + (index === 0 ? "bg-blue-50 text-blue-800 font-bold border-blue-100" : "text-gray-600");
                btn.innerHTML = `ğŸ“… ${item.date}`;
                btn.onclick = () => {
                    // é¸æŠçŠ¶æ…‹ã®è¦‹ãŸç›®ã‚’æ›´æ–°
                    Array.from(listEl.children).forEach(c => c.className = "w-full text-left p-2 rounded text-sm hover:bg-blue-50 text-gray-600 transition mb-1");
                    btn.className = "w-full text-left p-2 rounded text-sm bg-blue-50 text-blue-800 font-bold border border-blue-100 transition mb-1";
                    loadLogDetail(item.id);
                };
                listEl.appendChild(btn);
            });

            // æœ€æ–°ã‚’ãƒ­ãƒ¼ãƒ‰
            if(list.length > 0) loadLogDetail(list[0].id);
        }

        async function loadLogDetail(id) {
            try {
                // ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„ã‚ˆã†ã«ãƒˆãƒƒãƒ—ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„æ–¹ãŒã„ã„ã‹ã‚‚ã ãŒã€ãƒ•ã‚©ãƒ¼ãƒ ã¸ç§»å‹•
                if(window.innerWidth < 1024) {
                    // ã‚¹ãƒãƒ›ãªã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã®ä½ç½®ã¾ã§å°‘ã—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    // document.getElementById('code').scrollIntoView({behavior: 'smooth'});
                }

                const res = await fetch(`/get_log/${id}`);
                if (!res.ok) return;
                const data = await res.json();
                
                document.getElementById('log_id').value = data.id;
                document.getElementById('code').value = data.code;
                document.getElementById('name').value = data.name || "";
                document.getElementById('holding_qty').value = data.holding_qty || "";
                document.getElementById('avg_cost').value = data.avg_cost || "";
                document.getElementById('target_buy').value = data.target_buy || "";
                document.getElementById('target_sell').value = data.target_sell || "";
                document.getElementById('memo').value = data.memo || "";
                document.getElementById('analysis_memo').value = data.analysis_memo || "";
                document.getElementById('urls').value = data.urls || "";

                const setImg = (eid, has) => {
                    const el = document.getElementById(eid);
                    el.innerText = has ? "âœ… æ¸ˆ" : "æœª";
                    el.className = has ? "text-green-600 font-bold text-xs" : "text-gray-300 text-xs";
                };
                setImg('s_daily', data.has_daily);
                setImg('s_5min', data.has_5min);
                setImg('s_board', data.has_board);

                document.getElementById('delete_btn').classList.remove('hidden');
                document.getElementById('copy_btn').classList.remove('hidden');
                
            } catch(e) { console.error(e); }
        }

        function createNewLogForStock() {
            if(!currentCode) return;
            document.getElementById('log_id').value = ""; 
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚³ãƒ¼ãƒ‰ã¨åå‰ä»¥å¤–ï¼‰
            document.getElementById('memo').value = "";
            document.getElementById('analysis_memo').value = "";
            document.getElementById('copy_btn').classList.add('hidden');
            document.getElementById('delete_btn').classList.add('hidden');
            // ç”»åƒçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            ['s_daily', 's_5min', 's_board'].forEach(id => {
                document.getElementById(id).innerText = "æœª";
                document.getElementById(id).className = "text-gray-300 text-xs";
            });
        }

        function createNewLog() {
            currentCode = "";
            document.getElementById('history_list').innerHTML = '<p class="text-xs text-gray-400 text-center py-2">éŠ˜æŸ„ã‚’é¸ã‚“ã§ãª</p>';
            document.getElementById('selected_code_display').innerText = "";
            document.getElementById('add_new_btn').disabled = true;
            
            document.getElementById('log_id').value = "";
            document.getElementById('code').value = "";
            document.getElementById('name').value = "";
            document.getElementById('memo').value = "";
            ['holding_qty','avg_cost','target_buy','target_sell','urls','analysis_memo'].forEach(id => document.getElementById(id).value="");
            
            document.getElementById('copy_btn').classList.add('hidden');
            document.getElementById('delete_btn').classList.add('hidden');
        }

        function deleteLog() {
            const id = document.getElementById('log_id').value;
            if(!id) return;
            if(confirm("ã»ã‚“ã¾ã«å‰Šé™¤ã—ã¦ãˆãˆã‹ï¼Ÿ")) {
                document.getElementById('delete_log_id').value = id;
                document.getElementById('deleteForm').submit();
            }
        }

        async function copyDataToClipboard() {
            const id = document.getElementById('log_id').value;
            if(!id) return;
            try {
                const res = await fetch(`/download_notebooklm/${id}`);
                if(res.ok) {
                    const text = await res.text();
                    await navigator.clipboard.writeText(text);
                    alert("âœ… ã‚³ãƒ”ãƒ¼ã—ãŸã§ï¼\nNotebookLMã«è²¼ã‚Šä»˜ã‘ã¦ãªã€‚");
                }
            } catch(e) { alert("ã‚³ãƒ”ãƒ¼å¤±æ•—ã‚„..." + e); }
        }

        function preview(input, id) {
            if(input.files[0]) {
                const el = document.getElementById(id);
                el.innerText = "âœ… é¸æŠ";
                el.className = "text-blue-600 font-bold text-xs";
            }
        }
    </script>
</body>
</html>
