<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>短期トレードAI判定ツール（環境記憶つき）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 16px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
          sans-serif;
        background: #f5f7fb;
        color: #1f2933;
      }
      .container {
        max-width: 880px;
        margin: 0 auto;
      }
      h1 {
        font-size: 20px;
        margin-bottom: 4px;
      }
      .sub {
        font-size: 13px;
        color: #6b7b93;
        margin-bottom: 16px;
      }
      .card {
        background: #ffffff;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        margin-bottom: 16px;
      }
      .card-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .field {
        margin-bottom: 12px;
      }
      label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      input[type="file"],
      textarea {
        width: 100%;
        font-size: 13px;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #d0d7e2;
        background: #f9fafb;
      }
      textarea {
        resize: vertical;
        min-height: 60px;
      }
      .btn-row {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 8px;
      }
      button {
        border: none;
        border-radius: 999px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        background: #2563eb;
        color: #ffffff;
      }
      button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .result-card {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .result-title {
        font-size: 14px;
        font-weight: 600;
        color: #4b5563;
      }
      .action-text {
        font-size: 32px;
        font-weight: 800;
        letter-spacing: 0.1em;
      }
      .action-buy {
        color: #16a34a;
      }
      .action-sell {
        color: #dc2626;
      }
      .action-hold {
        color: #2563eb;
      }
      .reason {
        font-size: 13px;
        color: #4b5563;
        line-height: 1.5;
      }
      .error {
        font-size: 13px;
        color: #dc2626;
        margin-bottom: 8px;
      }
      .env-summary {
        font-size: 13px;
        color: #4b5563;
        white-space: pre-wrap;
      }
      .hint {
        font-size: 12px;
        color: #9ca3af;
      }
      .env-message {
        font-size: 13px;
        color: #16a34a;
        margin-bottom: 4px;
      }
      @media (max-width: 600px) {
        .container {
          padding: 0 4px;
        }
        .card {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>短期トレードAI判定ツール（環境記憶つき）</h1>
      <div class="sub">
        上のカードで<strong>日足・材料などの環境情報</strong>を登録しておくと、<br />
        下のカードでの判定時に毎回それを考慮してくれます（更新ボタンを押すまで有効）。
      </div>

      {% if error %}
      <div class="card">
        <div class="error">{{ error }}</div>
      </div>
      {% endif %}

      <!-- 環境・日足情報の登録カード -->
      <div class="card">
        <div class="card-title">1. 日足・材料などの環境情報を登録（任意・上書き）</div>

        {% if env_message %}
        <div class="env-message">{{ env_message }}</div>
        {% endif %}

        {% if env_summary %}
        <div class="env-summary">
          <strong>現在登録されている環境要約</strong>
          {% if env_updated_at %}（更新: {{ env_updated_at }}）{% endif %}<br />
          {{ env_summary }}
        </div>
        {% else %}
        <div class="env-summary hint">
          ※ まだ環境情報は登録されていません。必要なら日足やニュースURLを登録してください。
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data">
          <input type="hidden" name="mode" value="update_env" />

          <div class="field" style="margin-top: 12px">
            <label>日足チャート画像（任意・新しく登録すると上書き）</label>
            <input type="file" name="daily_image" accept="image/*" />
            <div class="hint">
              中期トレンドを把握するための日足スクショ。未指定なら前回の情報がそのまま残ります。
            </div>
          </div>

          <div class="field">
            <label>追加の参考画像（任意・複数可）</label>
            <input
              type="file"
              name="extra_images"
              accept="image/*"
              multiple
            />
            <div class="hint">
              例：60分足チャート、ニュース、ランキング、出来高情報のスクショなど。
            </div>
          </div>

          <div class="field">
            <label>参考にしてほしいURL（任意・複数行OK）</label>
            <textarea
              name="env_urls"
              placeholder="1行に1つずつURLを入力&#10;例: https://www.example.com/ir/..."
            ></textarea>
            <div class="hint">
              IR資料やニュース記事など。ツール側で中身を取得して要約に使います。
            </div>
          </div>

          <div class="field">
            <label>環境に関するメモ（任意）</label>
            <textarea
              name="env_memo"
              placeholder="例：決算は市場予想比やや良。自社株買い発表あり。直近はAI関連として物色されている 等"
            ></textarea>
          </div>

          <div class="btn-row">
            <button type="submit">環境・日足情報を更新する</button>
          </div>
        </form>
      </div>

      <!-- 個別判定カード -->
      <div class="card">
        <div class="card-title">2. 5分足＋板から短期のアクションを判定</div>
        <form method="POST" enctype="multipart/form-data">
          <input type="hidden" name="mode" value="judge" />

          <div class="field">
            <label>5分足チャート画像（必須）</label>
            <input
              type="file"
              name="chart_image"
              accept="image/*"
              required
            />
            <div class="hint">
              直近の5分足チャート（ローソク＋出来高）のスクショ。
            </div>
          </div>

          <div class="field">
            <label>気配値（板）の画像（必須）</label>
            <input type="file" name="board_image" accept="image/*" required />
            <div class="hint">
              売り板・買い板のスクショ。歩み値が含まれていてもOK。
            </div>
          </div>

          <div class="field">
            <label>このタイミング特有のメモ（任意）</label>
            <textarea
              name="memo"
              placeholder="例：寄り付き直後。直前に大きな成行買いあり 等"
            ></textarea>
          </div>

          <div class="btn-row">
            <button type="submit">この条件でAIに判定させる</button>
          </div>
        </form>
      </div>

      <!-- 判定結果 -->
      <div class="card">
        <div class="result-card">
          <div class="result-title">現在のAIアクション</div>
          {% if result %}
          <div
            class="action-text {% if result.action == 'BUY' %}action-buy{% elif result.action == 'SELL' %}action-sell{% else %}action-hold{% endif %}"
          >
            {{ result.action }}
          </div>
          <div class="reason">理由：{{ result.reason }}</div>
          {% else %}
          <div class="action-text action-hold">HOLD</div>
          <div class="reason">
            まだ判定は行われていません。上のフォームでスクショをアップして実行してください。
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </body>
</html>
