<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFM ãƒˆãƒ¬ãƒ¼ãƒ‰æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <style>
        @import url('[https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap](https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap)');
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 max-w-3xl mx-auto">

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6">
                {% for category, message in messages %}
                    <div class="p-4 mb-2 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700 border-red-400{% else %}bg-green-100 text-green-700 border-green-400{% endif %} border">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <header class="mb-6">
        <h1 class="text-2xl font-bold flex items-center gap-2 mb-2">
            <span class="text-red-500 text-3xl">ğŸ“ˆ</span>
            SFM ãƒˆãƒ¬ãƒ¼ãƒ‰æ”¯æ´ãƒ„ãƒ¼ãƒ«
        </h1>
        <p class="text-sm text-gray-700 leading-relaxed">
            ä¸Šéƒ¨ã§ã€Œç’°å¢ƒèªè­˜ã€ã‚’ç™»éŒ²ã—ã¦ã‹ã‚‰ã€ä¸‹éƒ¨ã§ã€Œ5åˆ†è¶³ï¼‹æ¿ã€ã‚’é€ã‚‹ã¨ã€AIãŒçµ±åˆçš„ã«åˆ¤æ–­ã—ã¾ã™ã€‚
        </p>
    </header>

    {% if judge_result %}
    <section class="bg-blue-50 rounded-xl p-6 shadow-md border-2 border-blue-200 mb-8">
        <h2 class="font-bold text-xl mb-4 text-blue-800">ğŸ¤– AIã®åˆ¤å®šçµæœ</h2>
        <div class="prose max-w-none">
            {{ judge_result | safe }}
        </div>
        <div class="mt-4 text-center">
            <a href="{{ url_for('index') }}" class="text-blue-600 underline text-sm">ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ã„åˆ¤å®šã‚’è¡Œã†</a>
        </div>
    </section>
    {% endif %}

    <section class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 mb-8">
        <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="text-green-500 text-xl">ğŸ“</span>
            â‘  æ—¥è¶³ãƒ»ææ–™ãªã©ã®ç’°å¢ƒæƒ…å ±ã‚’ç™»éŒ²
        </h2>
        
        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
            <h3 class="text-sm font-bold text-gray-500 mb-2">ç¾åœ¨ãƒ¡ãƒ¢ãƒªã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹éŠ˜æŸ„:</h3>
            {% if registered_envs %}
                <ul class="space-y-2">
                    {% for code, data in registered_envs.items() %}
                        <li class="flex items-start gap-2 text-sm border-b pb-2 last:border-0">
                            <span class="bg-gray-200 text-gray-800 px-2 py-0.5 rounded font-mono font-bold">{{ code }}</span>
                            <div>
                                <span class="font-bold">{{ data.name }}</span><br>
                                <span class="text-gray-500 text-xs">{{ data.memo }}</span>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-gray-400 text-sm">ã¾ã ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </div>

        <form action="{{ url_for('save_environment') }}" method="POST" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-1">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰</label>
                    <input type="text" name="env_stock_code" placeholder="ä¾‹: 9434" class="w-full border border-gray-300 rounded-lg p-3" required>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-1">éŠ˜æŸ„åï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" name="env_stock_name" placeholder="ä¾‹: ã‚½ãƒ•ãƒãƒ³" class="w-full border border-gray-300 rounded-lg p-3">
                </div>
            </div>
            <div>
                 <label class="block text-gray-700 text-sm font-medium mb-1">æ—¥è¶³ãƒ»ç’°å¢ƒèªè­˜ãƒ¡ãƒ¢</label>
                <textarea name="env_memo" placeholder="ä¾‹: ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ä¸­ã€‚æ±ºç®—é€šéæ¸ˆã¿ã€‚" class="w-full border border-gray-300 rounded-lg p-3 h-20 resize-none"></textarea>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-medium mb-1">å‚è€ƒãƒ‹ãƒ¥ãƒ¼ã‚¹URLï¼ˆä»»æ„ãƒ»è¤‡æ•°å¯ï¼‰</label>
               <textarea name="env_urls" placeholder="http://... (æ”¹è¡Œã§åŒºåˆ‡ã£ã¦è¤‡æ•°å…¥åŠ›å¯)" class="w-full border border-gray-300 rounded-lg p-3 h-20 resize-none"></textarea>
           </div>
             <button type="submit" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-lg transition">
                ç’°å¢ƒæƒ…å ±ã‚’ä¿å­˜ã™ã‚‹
            </button>
        </form>
    </section>

    <section class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
        <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="text-red-500 text-xl">âš¡</span>
            â‘¡ 5åˆ†è¶³ï¼‹æ¿ã‹ã‚‰çŸ­æœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¤å®š
        </h2>

        <form action="{{ url_for('judge') }}" method="POST" enctype="multipart/form-data" class="space-y-5" onsubmit="showLoader()">
            
            <div>
                <label class="block text-gray-700 text-sm font-medium mb-1">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ï¼ˆåˆ¤å®šã™ã‚‹å¯¾è±¡ï¼‰</label>
                <input type="text" name="stock_code" value="{{ form_values.stock_code if form_values else '' }}" placeholder="ä¾‹: 9434" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-1">5åˆ†è¶³ãƒãƒ£ãƒ¼ãƒˆç”»åƒ</label>
                    <div class="flex items-center gap-2 mb-1">
                        <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 border border-gray-300 text-gray-700 px-3 py-2 rounded text-sm transition w-full text-center">
                            ãƒãƒ£ãƒ¼ãƒˆã‚’é¸æŠ
                            <input type="file" name="chart_image" id="chartImg" class="hidden" accept="image/*" required>
                        </label>
                    </div>
                    <span id="chartImgName" class="text-xs text-gray-500 block truncate">é¸æŠãªã—</span>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-1">æ°—é…å€¤ï¼ˆæ¿ï¼‰ç”»åƒ</label>
                    <div class="flex items-center gap-2 mb-1">
                        <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 border border-gray-300 text-gray-700 px-3 py-2 rounded text-sm transition w-full text-center">
                            æ¿ç”»åƒã‚’é¸æŠ
                            <input type="file" name="orderbook_image" id="boardImg" class="hidden" accept="image/*" required>
                        </label>
                    </div>
                    <span id="boardImgName" class="text-xs text-gray-500 block truncate">é¸æŠãªã—</span>
                </div>
            </div>

            <div>
                <label class="block text-gray-700 text-sm font-medium mb-1">è£œè¶³ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                <textarea name="extra_note" placeholder="ä¾‹: 3365å††ã§å£²ã‚Šæ¿ãŒåšã„æ°—ãŒã™ã‚‹..." class="w-full border border-gray-300 rounded-lg p-3 h-24 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none">{{ form_values.extra_note if form_values else '' }}</textarea>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-full transition shadow-md flex justify-center items-center gap-2">
                <span>AIã«åˆ¤å®šã—ã¦ã‚‚ã‚‰ã†</span>
                <div class="loader" id="loadingSpinner"></div>
            </button>

        </form>
    </section>

    <script>
        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½
        document.getElementById('chartImg').addEventListener('change', function(e){
            if(e.target.files[0]) document.getElementById('chartImgName').innerText = e.target.files[0].name;
        });
        document.getElementById('boardImg').addEventListener('change', function(e){
            if(e.target.files[0]) document.getElementById('boardImgName').innerText = e.target.files[0].name;
        });

        // é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
        function showLoader() {
            const btn = document.getElementById('submitBtn');
            const spinner = document.getElementById('loadingSpinner');
            
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            spinner.style.display = 'block';
            
            // æ–‡è¨€å¤‰æ›´
            btn.querySelector('span').innerText = 'AIãŒåˆ†æä¸­...';
        }
    </script>
</body>
</html>
