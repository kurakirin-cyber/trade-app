<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SFM ãƒˆãƒ¬ãƒ¼ãƒ‰æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; background: #fafafa; }
        h2 { margin-top: 30px; }
        input, textarea, select { width: 100%; padding: 7px; margin-top: 5px; }

        .section-box {
            background: #fff;
            padding: 18px; 
            border-radius: 8px; 
            border: 1px solid #ddd;
            margin-bottom: 25px;
        }
        .result-box {
            background: #e9f7ff;
            border-left: 4px solid #00a0ff;
            padding: 12px;
            margin-top: 15px;
        }
        .error-box {
            background: #ffe2e2;
            border-left: 4px solid #ff4d4d;
            padding: 12px;
            margin-top: 15px;
        }
        .env-box {
            background: #fdf7e6;
            padding: 10px;
            border-left: 4px solid #e6c200;
        }
    </style>
</head>
<body>

<h1>ğŸ“ˆ SFM ãƒˆãƒ¬ãƒ¼ãƒ‰æ”¯æ´ãƒ„ãƒ¼ãƒ«ï¼ˆ5åˆ†è¶³ï¼‹æ¿ â†’ AIåˆ¤å®šï¼‰</h1>

<!-- -------------------- éŠ˜æŸ„ä¸€è¦§ -------------------- -->
<div class="section-box">
    <h2>ğŸ” ç™»éŒ²æ¸ˆã¿éŠ˜æŸ„</h2>

    {% if env_list and env_list|length > 0 %}
        <select id="saved-symbol-select">
            <option value="">-- ç™»éŒ²æ¸ˆã¿éŠ˜æŸ„ã‚’é¸æŠ --</option>
            {% for s in env_list %}
                <option value="{{ s.symbol }}">{{ s.symbol }} {{ s.name }}</option>
            {% endfor %}
        </select>
    {% else %}
        <p>ã¾ã ç™»éŒ²ã•ã‚ŒãŸéŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
</div>


<!-- -------------------- â‘  5åˆ†è¶³ï¼‹æ¿ â†’ åˆ¤å®š -------------------- -->
<div class="section-box">
    <h2>â‘  5åˆ†è¶³ï¼‹æ¿ã‹ã‚‰çŸ­æœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¤å®š</h2>

    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="mode" value="judge">
        <input type="hidden" name="symbol_judge" id="symbol-judge-hidden">

        <label>éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ï¼ˆåˆ¤å®šã™ã‚‹å¯¾è±¡ï¼‰</label>
        <input type="text" id="symbol-input" placeholder="ä¾‹: 9434">

        <label>5åˆ†è¶³ãƒãƒ£ãƒ¼ãƒˆç”»åƒ</label>
        <input type="file" name="chart_image" accept="image/*">

        <label>æ°—é…å€¤ï¼ˆæ¿ï¼‰ç”»åƒ</label>
        <input type="file" name="board_image" accept="image/*">

        <label>è£œè¶³ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea name="memo" rows="3"></textarea>

        <button type="submit" style="margin-top:10px;">AI ã«åˆ¤å®šã—ã¦ã‚‚ã‚‰ã†</button>
    </form>

    {% if result %}
    <div class="result-box">
        <h3>ã€AI åˆ¤å®šçµæœã€‘éŠ˜æŸ„ï¼š{{ result.symbol }}</h3>
        <p><b>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š</b> {{ result.action }}</p>
        <p><b>ç†ç”±ï¼š</b> {{ result.reason }}</p>

        {% if result.buy_range %}
        <p><b>è²·ã„ç‹™ã„ï¼š</b> {{ result.buy_range }}</p>
        {% endif %}

        {% if result.sell_range %}
        <p><b>å£²ã‚Šç‹™ã„ï¼š</b> {{ result.sell_range }}</p>
        {% endif %}
    </div>
    {% endif %}

    {% if error %}
    <div class="error-box">
        <p>{{ error }}</p>
    </div>
    {% endif %}

</div>


<!-- -------------------- â‘¡ éŠ˜æŸ„ã”ã¨ã®ç’°å¢ƒï¼ˆæ—¥è¶³ï¼‹ææ–™ï¼‰ç™»éŒ² -------------------- -->
<div class="section-box">
    <h2>â‘¡ æ—¥è¶³ãƒ»ææ–™ãªã©ã®ç’°å¢ƒæƒ…å ±ã‚’ç™»éŒ²ï¼ˆéŠ˜æŸ„ã”ã¨ã«ä¿å­˜ï¼‰</h2>

    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="mode" value="update_env">

        <label>éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ï¼ˆå¿…é ˆï¼‰</label>
        <input type="text" id="symbol-env-display" placeholder="ä¾‹: 9434">
        <input type="hidden" name="symbol_env" id="symbol-env-hidden">

        <label>éŠ˜æŸ„åï¼ˆä»»æ„ãƒ»ãƒ¡ãƒ¢ä»£ã‚ã‚Šï¼‰</label>
        <input type="text" name="stock_name" placeholder="ä¾‹: ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯">

        <label>æ—¥è¶³ãƒãƒ£ãƒ¼ãƒˆç”»åƒï¼ˆä»»æ„ï¼‰</label>
        <input type="file" name="daily_image" accept="image/*">

        <label>è¿½åŠ ã®å‚è€ƒç”»åƒï¼ˆè¤‡æ•°å¯ï¼‰</label>
        <input type="file" name="extra_images" accept="image/*" multiple>

        <label>å‚è€ƒURLï¼ˆè¤‡æ•°è¡ŒOKï¼‰</label>
        <textarea name="env_urls" rows="3" placeholder="https://example.com"></textarea>

        <label>ç’°å¢ƒãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea name="env_memo" rows="3"></textarea>

        <button type="submit" style="margin-top:10px;">ã“ã®éŠ˜æŸ„ã®ç’°å¢ƒã‚’æ›´æ–°ã™ã‚‹</button>
    </form>

    {% if env_message %}
    <div class="env-box" style="margin-top:10px;">
        <p>{{ env_message }}</p>
    </div>
    {% endif %}
</div>


<!-- -------------------- JSï¼šéŠ˜æŸ„åŒæœŸãƒ­ã‚¸ãƒƒã‚¯ -------------------- -->
<script>
    const symbolInput = document.getElementById("symbol-input");
    const savedSelect = document.getElementById("saved-symbol-select");
    const symbolJudgeHidden = document.getElementById("symbol-judge-hidden");
    const symbolEnvHidden = document.getElementById("symbol-env-hidden");
    const symbolEnvDisplay = document.getElementById("symbol-env-display");

    function syncHiddenSymbol() {
        const v = (symbolInput.value || "").trim();
        symbolJudgeHidden.value = v;
        // åˆ¤å®šã¨ç’°å¢ƒç™»éŒ²ã‚’ä¸¡æ–¹åŒæœŸ
        symbolEnvHidden.value = v;
        if (symbolEnvDisplay) symbolEnvDisplay.value = v;
    }

    if (symbolInput) {
        symbolInput.addEventListener("input", syncHiddenSymbol);
    }

    if (savedSelect) {
        savedSelect.addEventListener("change", () => {
            const sym = savedSelect.value || "";
            symbolInput.value = sym;
            syncHiddenSymbol();
        });
    }

    if (symbolEnvDisplay) {
        symbolEnvDisplay.addEventListener("input", () => {
            const v = symbolEnvDisplay.value.trim();
            symbolEnvHidden.value = v;
            symbolInput.value = v;
            symbolJudgeHidden.value = v;
        });
    }

    syncHiddenSymbol();
</script>

</body>
</html>
