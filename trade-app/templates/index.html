<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        #loading_overlay { display: none; }
        #loading_overlay.active { display: flex; }
    </style>
</head>
<body class="min-h-screen pb-12">

    <div id="loading_overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 justify-center items-center flex-col">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4"></div>
        <p class="text-white font-bold">ä¿å­˜ä¸­...ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ã«å°‘ã—æ™‚é–“ã‹ã‹ã‚‹ã§ï¼‰</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-11/12 max-w-lg">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-xl mb-2 flex justify-between items-center text-white font-bold {% if category == 'error' %}bg-red-500{% else %}bg-blue-600{% endif %} fade-in">
                        <span>{{ message }}</span>
                        <button onclick="this.parentElement.remove()">Ã—</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <header class="bg-white border-b px-4 py-3 shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2">
                <span>ğŸ“ˆ</span> <span class="hidden md:inline">ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ç®¡ç†</span><span class="md:hidden">ãƒˆãƒ¬ãƒ¼ãƒ‰ç®¡ç†</span>
            </h1>
            <button onclick="createNewLog()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow text-xs md:text-sm flex items-center gap-1">
                <span>ï¼‹</span><span>æ–°è¦ä½œæˆ</span>
            </button>
        </div>
    </header>

    <div class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-3 space-y-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-3 bg-gray-50 border-b font-bold text-gray-500 text-xs">ğŸ“‚ éŠ˜æŸ„ã‚’é¸æŠ</div>
                <div class="p-3 bg-white">
                    <select id="stock_selector" onchange="selectStock(this.value)" class="w-full border border-gray-300 rounded p-2 text-sm font-bold text-gray-700 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <option value="">-- éŠ˜æŸ„ã‚’é¸æŠ --</option>
                        {% for code, data in registered_envs.items() %}
                            <option value="{{ code }}">
                                {{ code }} : {{ data.name }}
                                {% if data.holding_qty|int > 0 %}(ä¿æœ‰){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div id="history_section" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hidden lg:block">
                <div class="p-3 bg-gray-100 border-b font-bold text-gray-500 text-xs flex justify-between items-center">
                    <span>ğŸ•’ å±¥æ­´</span>
                    <span id="selected_code_display" class="text-blue-600"></span>
                </div>
                <div class="p-2 border-b">
                    <button onclick="createNewLogForStock()" id="add_new_btn" class="w-full bg-white border-2 border-dashed border-gray-300 text-gray-500 py-2 rounded hover:border-blue-400 hover:text-blue-500 transition text-xs font-bold disabled:opacity-50" disabled>
                        ï¼‹ ã“ã®éŠ˜æŸ„ã§è¨˜éŒ²è¿½åŠ 
                    </button>
                </div>
                <div id="history_list" class="max-h-48 lg:max-h-[calc(70vh-200px)] overflow-y-auto p-2 space-y-1">
                    <p class="text-xs text-gray-400 text-center py-2">éŠ˜æŸ„ã‚’é¸ã‚“ã§ãª</p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-9">
            <div class="bg-white rounded-xl shadow-lg border-t-4 border-blue-600 overflow-hidden">
                <form action="{{ url_for('save_data') }}" method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
                    <input type="hidden" name="log_id" id="log_id">
                    
                    <div class="border-b p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-gray-50">
                        <div class="flex items-center gap-4 w-full md:w-auto">
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-gray-400">ã‚³ãƒ¼ãƒ‰</label>
                                <input type="text" name="code" id="code" class="border-b-2 border-gray-300 focus:border-blue-500 outline-none font-bold text-xl w-24 bg-transparent" placeholder="9984" required>
                            </div>
                            <div class="flex flex-col flex-1">
                                <label class="text-[10px] font-bold text-gray-400">éŠ˜æŸ„å</label>
                                <input type="text" name="name" id="name" class="border-b border-gray-200 focus:border-blue-500 outline-none w-full bg-transparent" placeholder="éŠ˜æŸ„å">
                            </div>
                        </div>
                        
                        <div class="flex gap-2 w-full md:w-auto justify-end">
                            <button type="button" id="copy_btn" onclick="copyDataToClipboard()" disabled class="bg-gray-400 text-white py-2 px-4 rounded shadow text-sm flex items-center gap-2 transition cursor-not-allowed">
                                <span>âŒ›</span><span class="hidden md:inline">æº–å‚™ä¸­...</span>
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow flex items-center gap-2">
                                <span>ğŸ’¾ ä¿å­˜</span>
                            </button>
                        </div>
                    </div>

                    <div class="p-4 md:p-6 space-y-6">
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                                <h3 class="text-xs font-bold text-yellow-800 mb-2">ğŸ’° ä¿æœ‰çŠ¶æ³</h3>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" name="holding_qty" id="holding_qty" class="border p-2 rounded text-right w-full" placeholder="æ ªæ•°">
                                    <input type="number" name="avg_cost" id="avg_cost" class="border p-2 rounded text-right w-full" placeholder="å˜ä¾¡">
                                </div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                                <h3 class="text-xs font-bold text-green-800 mb-2">ğŸ¯ NotebookLM æˆ¦ç•¥</h3>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" name="target_buy" id="target_buy" class="border p-2 rounded text-center w-full" placeholder="è²·ã„ç‹™ã„">
                                    <input type="text" name="target_sell" id="target_sell" class="border p-2 rounded text-center w-full" placeholder="å£²ã‚Šç‹™ã„">
                                </div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ğŸ“ ç’°å¢ƒèªè­˜ãƒ»ãƒ¡ãƒ¢</label>
                                <textarea name="memo" id="memo" class="w-full border p-3 rounded-lg text-sm h-32 outline-none focus:border-blue-400" placeholder="æ°—ã¥ãã‚„è€ƒå¯Ÿ..."></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ğŸ¤– AIåˆ†æãƒ­ã‚°</label>
                                <textarea name="analysis_memo" id="analysis_memo" class="w-full border p-3 rounded-lg text-sm h-32 bg-green-50 border-green-200 outline-none focus:border-green-400" placeholder="AIã®å›ç­”ã‚’ã“ã“ã«ã‚³ãƒ”ãƒš..."></textarea>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-gray-500">ğŸ“¸ ãƒãƒ£ãƒ¼ãƒˆç”»åƒ (ä¸Šæ›¸ãä¿å­˜ã®ã¿)</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="flex flex-col gap-1">
                                        <label class="border-2 border-dashed rounded p-2 text-center cursor-pointer hover:bg-gray-50 h-full flex flex-col justify-center items-center">
                                            <span class="text-[10px] block font-bold text-gray-500">æ—¥è¶³</span>
                                            <input type="file" name="img_daily" class="hidden" onchange="preview(this, 's_daily')">
                                            <div id="s_daily" class="text-gray-300 text-xs mt-1">æœª</div>
                                        </label>
                                        <a id="btn_view_daily" href="#" target="_blank" class="hidden text-center text-[10px] bg-blue-100 text-blue-700 py-1 rounded hover:bg-blue-200">ğŸ‘ï¸ è¦‹ã‚‹</a>
                                    </div>
                                    <div class="flex flex-col gap-1">
                                        <label class="border-2 border-dashed rounded p-2 text-center cursor-pointer hover:bg-gray-50 h-full flex flex-col justify-center items-center">
                                            <span class="text-[10px] block font-bold text-gray-500">5åˆ†è¶³</span>
                                            <input type="file" name="img_5min" class="hidden" onchange="preview(this, 's_5min')">
                                            <div id="s_5min" class="text-gray-300 text-xs mt-1">æœª</div>
                                        </label>
                                        <a id="btn_view_5min" href="#" target="_blank" class="hidden text-center text-[10px] bg-blue-100 text-blue-700 py-1 rounded hover:bg-blue-200">ğŸ‘ï¸ è¦‹ã‚‹</a>
                                    </div>
                                    <div class="flex flex-col gap-1">
                                        <label class="border-2 border-dashed rounded p-2 text-center cursor-pointer hover:bg-gray-50 h-full flex flex-col justify-center items-center">
                                            <span class="text-[10px] block font-bold text-gray-500">æ¿</span>
                                            <input type="file" name="img_board" class="hidden" onchange="preview(this, 's_board')">
                                            <div id="s_board" class="text-gray-300 text-xs mt-1">æœª</div>
                                        </label>
                                        <a id="btn_view_board" href="#" target="_blank" class="hidden text-center text-[10px] bg-blue-100 text-blue-700 py-1 rounded hover:bg-blue-200">ğŸ‘ï¸ è¦‹ã‚‹</a>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ğŸ”— ãƒ‹ãƒ¥ãƒ¼ã‚¹URL</label>
                                <textarea name="urls" id="urls" class="w-full border p-2 rounded text-xs h-20 outline-none focus:border-blue-400" placeholder="https://..."></textarea>
                                <p class="text-[10px] text-gray-400 mt-1">â€»å¤‰æ›´ãŒãªã„å ´åˆã€å†å–å¾—ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™</p>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="bg-gray-50 p-4 border-t flex justify-end">
                    <button onclick="deleteLog()" id="delete_btn" class="hidden text-red-500 text-xs hover:bg-red-50 px-3 py-1 rounded transition">
                        ğŸ—‘ï¸ ã“ã®å±¥æ­´ã‚’å‰Šé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <form id="deleteForm" action="{{ url_for('delete_log') }}" method="POST" class="hidden">
        <input type="hidden" name="delete_log_id" id="delete_log_id">
    </form>

    <script>
        let currentCode = "";
        let currentCopyText = ""; // ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸€æ™‚ä¿å­˜ã™ã‚‹å¤‰æ•°

        function showLoading() {
            document.getElementById('loading_overlay').classList.add('active');
        }

        function showHistorySection() {
            const section = document.getElementById('history_section');
            section.classList.remove('hidden'); 
            section.classList.add('block');
        }

        async function selectStock(code) {
            if(!code) return; 

            currentCode = code;
            document.getElementById('selected_code_display').innerText = code;
            document.getElementById('add_new_btn').disabled = false;
            
            showHistorySection();
            document.getElementById('stock_selector').value = code;

            const res = await fetch(`/get_history/${code}`);
            const list = await res.json();
            
            const listEl = document.getElementById('history_list');
            listEl.innerHTML = "";
            
            if (list.length === 0) {
                listEl.innerHTML = '<p class="text-xs text-gray-400 text-center">å±¥æ­´ãªã—</p>';
                createNewLogForStock();
                return;
            }

            list.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-2 rounded text-sm hover:bg-blue-50 border border-transparent transition mb-1 " + (index === 0 ? "bg-blue-50 text-blue-800 font-bold border-blue-100" : "text-gray-600");
                btn.innerHTML = `ğŸ“… ${item.date}`;
                btn.onclick = () => {
                    Array.from(listEl.children).forEach(c => c.className = "w-full text-left p-2 rounded text-sm hover:bg-blue-50 text-gray-600 transition mb-1");
                    btn.className = "w-full text-left p-2 rounded text-sm bg-blue-50 text-blue-800 font-bold border border-blue-100 transition mb-1";
                    loadLogDetail(item.id);
                };
                listEl.appendChild(btn);
            });

            if(list.length > 0) loadLogDetail(list[0].id);
        }

        async function loadLogDetail(id) {
            try {
                // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’ã€Œæº–å‚™ä¸­ã€ã«ã—ã¦ç„¡åŠ¹åŒ–
                const copyBtn = document.getElementById('copy_btn');
                copyBtn.disabled = true;
                copyBtn.classList.remove('bg-gray-700', 'hover:bg-gray-800');
                copyBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                copyBtn.innerHTML = "<span>âŒ›</span><span class='hidden md:inline'>æº–å‚™ä¸­...</span>";
                currentCopyText = ""; // ãƒªã‚»ãƒƒãƒˆ

                const res = await fetch(`/get_log/${id}`);
                if (!res.ok) return;
                const data = await res.json();
                
                document.getElementById('log_id').value = data.id;
                document.getElementById('code').value = data.code;
                document.getElementById('name').value = data.name || "";
                document.getElementById('holding_qty').value = data.holding_qty || "";
                document.getElementById('avg_cost').value = data.avg_cost || "";
                document.getElementById('target_buy').value = data.target_buy || "";
                document.getElementById('target_sell').value = data.target_sell || "";
                document.getElementById('memo').value = data.memo || "";
                document.getElementById('analysis_memo').value = data.analysis_memo || "";
                document.getElementById('urls').value = data.urls || "";

                const setupImg = (type, has) => {
                    const statusEl = document.getElementById('s_' + type.split('_')[1]);
                    const btnEl = document.getElementById('btn_view_' + type.split('_')[1]);
                    statusEl.innerText = has ? "âœ… ä¿å­˜æ¸ˆ" : "æœª";
                    statusEl.className = has ? "text-green-600 font-bold text-xs mt-1" : "text-gray-300 text-xs mt-1";
                    if (has) {
                        btnEl.href = `/image/${data.id}/${type}`;
                        btnEl.classList.remove('hidden');
                    } else {
                        btnEl.classList.add('hidden');
                        btnEl.href = "#";
                    }
                };
                setupImg('img_daily', data.has_daily);
                setupImg('img_5min', data.has_5min);
                setupImg('img_board', data.has_board);

                document.getElementById('delete_btn').classList.remove('hidden');
                
                // ã€é‡è¦ã€‘ã“ã“ã§ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œè£ã§ã€å–å¾—ã—ã¦ãŠãï¼ˆå…ˆèª­ã¿ï¼‰
                fetch(`/download_notebooklm/${id}`)
                    .then(r => r.text())
                    .then(text => {
                        currentCopyText = text;
                        // å–å¾—ã§ããŸã‚‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                        copyBtn.disabled = false;
                        copyBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        copyBtn.classList.add('bg-gray-700', 'hover:bg-gray-800');
                        copyBtn.innerHTML = "<span>ğŸ“‹</span><span class='hidden md:inline'>ã‚³ãƒ”ãƒ¼</span>";
                    })
                    .catch(e => console.error("Text pre-fetch failed", e));
                
            } catch(e) { console.error(e); }
        }

        function createNewLogForStock() {
            if(!currentCode) return;
            resetForm();
            document.getElementById('code').value = currentCode;
        }

        function createNewLog() {
            currentCode = "";
            document.getElementById('stock_selector').value = ""; 
            document.getElementById('history_list').innerHTML = '<p class="text-xs text-gray-400 text-center py-2">éŠ˜æŸ„ã‚’é¸ã‚“ã§ãª</p>';
            document.getElementById('selected_code_display').innerText = "";
            document.getElementById('add_new_btn').disabled = true;
            resetForm();
        }

        function resetForm() {
            document.getElementById('log_id').value = "";
            document.getElementById('code').value = "";
            document.getElementById('name').value = "";
            document.getElementById('memo').value = "";
            ['holding_qty','avg_cost','target_buy','target_sell','urls','analysis_memo'].forEach(id => document.getElementById(id).value="");
            ['daily', '5min', 'board'].forEach(type => {
                document.getElementById('s_' + type).innerText = "æœª";
                document.getElementById('s_' + type).className = "text-gray-300 text-xs mt-1";
                document.getElementById('btn_view_' + type).classList.add('hidden');
            });
            
            // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’éš ã™
            const copyBtn = document.getElementById('copy_btn');
            copyBtn.disabled = true;
            copyBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            copyBtn.innerHTML = "<span>âŒ›</span><span class='hidden md:inline'>æº–å‚™ä¸­...</span>";
            currentCopyText = "";

            document.getElementById('delete_btn').classList.add('hidden');
        }

        function deleteLog() {
            const id = document.getElementById('log_id').value;
            if(!id) return;
            if(confirm("ã»ã‚“ã¾ã«å‰Šé™¤ã—ã¦ãˆãˆã‹ï¼Ÿ")) {
                document.getElementById('delete_log_id').value = id;
                document.getElementById('deleteForm').submit();
            }
        }

        async function copyDataToClipboard() {
            // å…ˆèª­ã¿ã—ãŸãƒ†ã‚­ã‚¹ãƒˆãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            if(!currentCopyText) {
                alert("âš ï¸ ã¾ã ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ä¸­ã‚„ã§ã€‚ã‚‚ã†ã¡ã‚‡ã£ã¨å¾…ã£ã¦ãªã€‚");
                return;
            }

            try {
                // ã™ã§ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã®ã§ã€å¾…æ©Ÿæ™‚é–“ã‚¼ãƒ­ã§ã‚³ãƒ”ãƒ¼ã§ãã‚‹ï¼ˆiOSã§ã‚‚é€šã‚‹ï¼ï¼‰
                await navigator.clipboard.writeText(currentCopyText);
                alert("âœ… ã‚³ãƒ”ãƒ¼ã—ãŸã§ï¼\nNotebookLMã«è²¼ã‚Šä»˜ã‘ã¦ãªã€‚");
            } catch(e) {
                // ä¸‡ãŒä¸€ã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆiOSã®å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¯¾ç­–ï¼‰
                try {
                    const textarea = document.createElement("textarea");
                    textarea.value = currentCopyText;
                    textarea.style.position = "fixed"; // ç”»é¢å¤–ã¸
                    textarea.style.left = "-9999px";
                    document.body.appendChild(textarea);
                    textarea.focus();
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert("âœ… ã‚³ãƒ”ãƒ¼ã—ãŸã§ï¼ï¼ˆäºˆå‚™ãƒ¢ãƒ¼ãƒ‰ï¼‰");
                } catch(e2) {
                    alert("âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—ã‚„...\n" + e);
                }
            }
        }

        function preview(input, id) {
            if(input.files[0]) {
                const el = document.getElementById(id);
                el.innerText = "âœ… é¸æŠä¸­";
                el.className = "text-blue-600 font-bold text-xs mt-1";
            }
        }
    </script>
</body>
</html>
